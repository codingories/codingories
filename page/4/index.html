<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"codingories.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="这个博客用来记录自己的生活">
<meta property="og:type" content="website">
<meta property="og:title" content="OriesノBlog">
<meta property="og:url" content="codingories.github.io/page/4/index.html">
<meta property="og:site_name" content="OriesノBlog">
<meta property="og:description" content="这个博客用来记录自己的生活">
<meta property="article:author" content="Ories">
<meta property="article:tag" content="编程 吉他 rap">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="codingories.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>OriesノBlog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">OriesノBlog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">朱骏杰的私人博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/31/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9035js%E4%B8%93%E7%B2%BE04%E4%B9%8B%E6%89%8Basync-await%E5%85%A8%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/31/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9035js%E4%B8%93%E7%B2%BE04%E4%B9%8B%E6%89%8Basync-await%E5%85%A8%E8%A7%A3/" class="post-title-link" itemprop="url">高级前端养成35js专精04之手async/await全解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-31 20:16:08" itemprop="dateCreated datePublished" datetime="2020-08-31T20:16:08+08:00">2020-08-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-09-03 22:12:31" itemprop="dateModified" datetime="2020-09-03T22:12:31+08:00">2020-09-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js%E4%B8%93%E7%B2%BE/" itemprop="url" rel="index"><span itemprop="name">js专精</span></a>
                </span>
            </span>

          
            <span id="/2020/08/31/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9035js%E4%B8%93%E7%B2%BE04%E4%B9%8B%E6%89%8Basync-await%E5%85%A8%E8%A7%A3/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成35js专精04之手async/await全解" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/31/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9035js%E4%B8%93%E7%B2%BE04%E4%B9%8B%E6%89%8Basync-await%E5%85%A8%E8%A7%A3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/31/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9035js%E4%B8%93%E7%B2%BE04%E4%B9%8B%E6%89%8Basync-await%E5%85%A8%E8%A7%A3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>约定</li>
</ol>
<ul>
<li>Promise 表示类</li>
<li>promise 表示实例对象</li>
</ul>
<ol start="2">
<li>基本用法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const result &#x3D; await promise</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>从 Promise 说起</li>
</ol>
<ul>
<li>Promise 封装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function 摇骰子()&#123;</span><br><span class="line">  return new Promise((resolve,reject)&#x3D;&gt;&#123;</span><br><span class="line">    setTimeout(()&#x3D;&gt;&#123;</span><br><span class="line">      resolve(Math.floor(Math.random()*6) + 1)</span><br><span class="line">    &#125;,3000)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 Promise</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">摇骰子().then(s1,f1).then(s2,f2)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果直接不加 setTimeout</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function 摇骰子()&#123;</span><br><span class="line">  return new Promise((resolve,reject)&#x3D;&gt;&#123;</span><br><span class="line">      resolve(Math.floor(Math.random()*6) + 1)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">摇骰子().then(n&#x3D;&gt;&#123;console.log(n)&#125;)</span><br><span class="line">console.log(&#39;end&#39;)</span><br><span class="line">&#x2F;&#x2F; 结果为end, n</span><br></pre></td></tr></table></figure>

<ul>
<li>如果后面再加 setTimeout</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function 摇骰子()&#123;</span><br><span class="line">  return new Promise((resolve,reject)&#x3D;&gt;&#123;</span><br><span class="line">      resolve(Math.floor(Math.random()*6) + 1)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">摇骰子().then(n&#x3D;&gt;&#123;console.log(&#39;n&#39;,n)&#125;)</span><br><span class="line">console.log(&#39;end&#39;)</span><br><span class="line">setTimeout(()&#x3D;&gt;&#123;</span><br><span class="line">  console.log(&#39;timeout&#39;,0)</span><br><span class="line">&#125;)</span><br><span class="line">&#x2F;&#x2F; 结果为end, n,控制台多出一个数字是setTimeOut的id</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>ES6 之前</li>
</ol>
<ul>
<li>只有正在执行的代码，和等待执行代码(即异步队列)
<img src="https://i.loli.net/2020/08/31/jaxXZDlv4komWKh.png" alt="ES6之前.png"></li>
<li>后来前端觉得回调太蛋疼，于是想出来 Promise<ul>
<li>如果 ajax 为缓存，那和直接写 SetTimeout(S1)效果一样，都是直接放到异步队列，这样的 api 过于蛋疼
<img src="https://i.loli.net/2020/08/31/1K4yitcu5wNxlqD.png" alt="蛋疼的api.png"></li>
<li>所以引入宏任务和微任务的概念，先执行微任务，微任务执行快
<img src="https://i.loli.net/2020/08/31/jxKYyLF1528MiBr.png" alt="宏任务和微任务.png"></li>
<li>一般 promise 都是微任务，setTimeout 是宏任务</li>
</ul>
</li>
</ul>
<ol start="5">
<li><p>宏任务 macrotask 和 微任务 microtask 任务模型</p>
<ul>
<li>先 Ma 后 Mi,一开始正在执行的任务也是大任务，其实一开始没有两个任务队列</li>
<li>为了让 Promise 回调更早执行，强行插入了一个队列</li>
<li>如果没有 Mi 任务，不如直接用 setTimeout</li>
</ul>
</li>
<li><p>Promise 的其他 API</p>
<ul>
<li><p>Promise.resolve(result),制造一个成功(或失败)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">function 摇骰子()&#123;</span><br><span class="line">  let result &#x3D; 4</span><br><span class="line">  return new Promise((resolve,reject)&#x3D;&gt;&#123;</span><br><span class="line">      resolve(4)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">摇骰子().then(n&#x3D;&gt;console.log(n))</span><br><span class="line">&#x2F;&#x2F; 上面这样写过于麻烦,简化成</span><br><span class="line">function 摇骰子()&#123;</span><br><span class="line">  let result &#x3D; 4</span><br><span class="line">  return Promise.resolve(4)</span><br><span class="line">  &#x2F;&#x2F; 值为4的Promise</span><br><span class="line">&#125;</span><br><span class="line">摇骰子().then(n&#x3D;&gt;console.log(n))</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; resolve制造失败的例子</span><br><span class="line">function 摇骰子()&#123;</span><br><span class="line">  return Promise.resolve(new Promise((resolve,reject)&#x3D;&gt;reject()))</span><br><span class="line">&#125;</span><br><span class="line">摇骰子()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.reject(reason)，制造一个失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Promise.reject(&#39;我错了&#39;).then(null, (reason)&#x3D;&gt;console.log(reason))</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.all(数组)，等待全部成功，或者有一个失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Promise.all([Promise.resolve(1),Promise.resolve(2),Promise.resolve(3)]).then(</span><br><span class="line">    values&#x3D;&gt;console.log(values)</span><br><span class="line">)</span><br><span class="line">&#x2F;&#x2F; [1,2,3]</span><br><span class="line">Promise.all([Promise.reject(1),Promise.resolve(2),Promise.resolve(3)]).then(</span><br><span class="line">  null,reason&#x3D;&gt;console.log(reason)</span><br><span class="line">)</span><br><span class="line">&#x2F;&#x2F; 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Promise.race(数组)，等待第一个状态改变</p>
<ul>
<li>使用场景，备份用户数据到某个服务器，根据用户所在区域备份，</li>
<li>同时备份中国用户和美国用户的数据哪个先成功</li>
</ul>
</li>
<li><p>Promise.allSettled(数组)，等待全部状态改变，目前处于 Stage-4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Promise.allSettled([Promise.reject(1),Promise.reject(2),Promise.resolve(3)]).then(</span><br><span class="line">  (reason)&#x3D;&gt;console.log(reason)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><a href="https://www.caniuse.com/#search=allSettled" target="_blank" rel="noopener">allSettled 兼容性</a>不是特别好</p>
</li>
<li><p>自己写一个 allSettled</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">task1 &#x3D; ()&#x3D;&gt; new Promise((resolve, reject)&#x3D;&gt;&#123;</span><br><span class="line">  setTimeout(()&#x3D;&gt;&#123;reject(&#39;第一扇门关了&#39;)&#125;,3000)</span><br><span class="line">&#125;)</span><br><span class="line">task2 &#x3D; ()&#x3D;&gt; new Promise((resolve, reject)&#x3D;&gt;&#123;</span><br><span class="line">  setTimeout(()&#x3D;&gt;&#123;reject(&#39;第二扇门关了&#39;)&#125;,4000)</span><br><span class="line">&#125;)</span><br><span class="line">task3 &#x3D; ()&#x3D;&gt; new Promise((resolve, reject)&#x3D;&gt;&#123;</span><br><span class="line">  setTimeout(()&#x3D;&gt;&#123;resolve(&#39;第三扇门开了&#39;)&#125;,5000)</span><br><span class="line">&#125;)</span><br><span class="line">&#x2F;&#x2F; 这样写只会打印出,第一扇门关了</span><br><span class="line">Promise.all([task1(),task2(),task3()]).</span><br><span class="line">  then(null, (reason)&#x3D;&gt;&#123;console.log(reason)&#125;)</span><br><span class="line">&#x2F;&#x2F; 都返回成功对象就行</span><br><span class="line"></span><br><span class="line">Promise.all([</span><br><span class="line">  task1().then(()&#x3D;&gt;(&#123;status:&#39;ok&#39;&#125;),()&#x3D;&gt;(&#123;status: &#39;not ok&#39;&#125;)),</span><br><span class="line">  task2().then(()&#x3D;&gt;(&#123;status:&#39;ok&#39;&#125;),()&#x3D;&gt;(&#123;status: &#39;not ok&#39;&#125;)),</span><br><span class="line">  task3().then(()&#x3D;&gt;(&#123;status:&#39;ok&#39;&#125;),()&#x3D;&gt;(&#123;status: &#39;not ok&#39;&#125;))</span><br><span class="line">  ]).then((reason)&#x3D;&gt;&#123;console.log(reason)&#125;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 对代码进行优化,通过转换函数x,x的意思是确保不会失败</span><br><span class="line">x &#x3D; (promise) &#x3D;&gt; promise.then(</span><br><span class="line">  (value)&#x3D;&gt;(&#123;status:&#39;ok&#39;,value&#125;),</span><br><span class="line">  (reason)&#x3D;&gt;(&#123;status: &#39;not ok&#39;,reason&#125;))</span><br><span class="line"></span><br><span class="line">Promise.all([</span><br><span class="line">  x(task1()),</span><br><span class="line">  x(task2()),</span><br><span class="line">  x(task3()),</span><br><span class="line">]).then((v)&#x3D;&gt;console.log(v))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 继续优化x</span><br><span class="line">x &#x3D; (promiseList) &#x3D;&gt; promiseList.map( promise &#x3D;&gt; promise.then(</span><br><span class="line">  (value)&#x3D;&gt;(&#123;status:&#39;ok&#39;,value&#125;),</span><br><span class="line">  (reason)&#x3D;&gt;(&#123;status: &#39;not ok&#39;,reason&#125;))</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Promise.all(x([task1(),task2(),task3()])).then((v)&#x3D;&gt;console.log(v))</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 继续优化，自己写一个Promise.allSettled2</span><br><span class="line">Promise.allSettled2 &#x3D; function(promiseList)&#123;</span><br><span class="line">  return Promise.all(x(promiseList))</span><br><span class="line">&#125;</span><br><span class="line">Promise.allSettled2(x([task1(),task2(),task3()])).then((v)&#x3D;&gt;console.log(v))</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p> Promise 的应用场景</p>
</li>
</ol>
<ul>
<li>多次处理一个结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">摇骰子.then(v&#x3D;&gt; v1 ).then(v1 &#x3D;&gt; v2)</span><br></pre></td></tr></table></figure>

<ul>
<li>串行<ul>
<li>这里有一个悖论:一旦 promise 出现，那么任务就已经执行了</li>
<li>所以不是 promise 串行，而是任务串行</li>
<li>解法:把任务放进队列，完成一个再做下一个</li>
</ul>
</li>
<li>并行<ul>
<li>Promise.all([p1,p2])不好用</li>
<li>Promise.allSettled 又太行</li>
<li>怎么办</li>
</ul>
</li>
<li>面试代码题<ul>
<li>页面有两个按钮 A 和 B,以及一个输入框,A 按钮点击后发送一个请求，返回一个字符串 A，B 也发请求，但返回字符串 B,返回后会把字符串赋值给输入框，但 A、B 发送的两个请求返回的时间不同，点击两个按钮的顺序也不一定，B 要比 A 先返回，而最终效果要求是输入框字符的顺序 A B。</li>
<li><img src="https://i.loli.net/2020/09/01/JGa5vScgDjOICBd.png" alt="面试题大致意思.png"></li>
<li>答案<ul>
<li>在工程上，如果发现有结果了之前的都不要，ajax 一般有 cancel 这个 api，一旦渲染结果就调用 cancel</li>
<li>对于题目，保证在第一个任务完成后调用第二个任务</li>
</ul>
</li>
</ul>
</li>
<li>这样写会出现点击 b1,b2,出现字符串 B,再出现字符串 A</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"b1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"b2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"input1"</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">ajax1 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">"字符串A"</span>);</span><br><span class="line">    &#125;, <span class="number">5000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">ajax2 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">"字符串B"</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">b1.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  ajax1().then(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    input1.value = s;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">b2.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  ajax2().then(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    input1.value = s;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>联想餐厅点餐逻辑,将任务放入队列，处理串行,点 a,b 就只出现’字符串 B’</li>
<li><img src="https://i.loli.net/2020/09/01/3AkUWGO2uRXiKHF.png" alt="餐厅取餐.png"></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">ajax1 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">"字符串A"</span>);</span><br><span class="line">    &#125;, <span class="number">5000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line">ajax2 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="string">"字符串B"</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">let</span> 取餐队伍 = [];</span><br><span class="line"><span class="keyword">let</span> 吧台 = [];</span><br><span class="line"><span class="keyword">let</span> 问 = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> lastN = 吧台[吧台.length - <span class="number">1</span>][<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">let</span> lastS = 吧台[吧台.length - <span class="number">1</span>][<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> (取餐队伍[<span class="number">0</span>][<span class="number">0</span>] === lastN) &#123;</span><br><span class="line">    取餐队伍[<span class="number">0</span>][<span class="number">1</span>].call(<span class="literal">null</span>, lastS);</span><br><span class="line">    取餐队伍.shift();</span><br><span class="line">    吧台.pop();</span><br><span class="line">    问();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">b1.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> n = <span class="built_in">Math</span>.random();</span><br><span class="line">  ajax1().then(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    吧台.push([n, s]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"吧台"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(吧台);</span><br><span class="line">    问();</span><br><span class="line">  &#125;);</span><br><span class="line">  取餐队伍.push([</span><br><span class="line">    n,</span><br><span class="line">    (s) =&gt; &#123;</span><br><span class="line">      input1.value = s;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(s);</span><br><span class="line">    &#125;,</span><br><span class="line">  ]);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"取餐队伍"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(取餐队伍);</span><br><span class="line">&#125;;</span><br><span class="line">b2.onclick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> n = <span class="built_in">Math</span>.random();</span><br><span class="line">  ajax2().then(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">    吧台.push([n, s]);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"吧台"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(吧台);</span><br><span class="line">    问();</span><br><span class="line">  &#125;);</span><br><span class="line">  取餐队伍.push([</span><br><span class="line">    n,</span><br><span class="line">    (s) =&gt; &#123;</span><br><span class="line">      input1.value = s;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">      <span class="built_in">console</span>.log(s);</span><br><span class="line">    &#125;,</span><br><span class="line">  ]);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"取餐队伍"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(取餐队伍);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>Promise 错误处理</li>
</ol>
<ul>
<li>其实挺好用的<ul>
<li>promise.then(s1,f1)即可</li>
<li>不行，我想要全局错误处理(以 axios 为例),见<a href="https://juejin.im/post/6844903569745788941#heading-6" target="_blank" rel="noopener">axios 作弊表</a>中的拦截器部分</li>
</ul>
</li>
<li>语法糖<ul>
<li>promise.then(s1).catch(f1)</li>
</ul>
</li>
<li>错误处理之后<ul>
<li>如果你没有继续跑错，那么错误就不会出现</li>
<li>如果继续抛错，那么后续回调就要继续处理错误</li>
</ul>
</li>
</ul>
<ol start="9">
<li>promise 挺好用，但是前端似乎对 Promise 不满</li>
</ol>
<ul>
<li><a href="https://blog.fundebug.com/2017/04/04/nodejs-async-await/" target="_blank" rel="noopener">async/await 替代 Promise 的 6 个理由</a></li>
</ul>
<ol start="10">
<li>async/await 基本用法</li>
</ol>
<ul>
<li>最常见用法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> temp = <span class="keyword">await</span> makePromise();</span><br><span class="line">  <span class="keyword">return</span> temp + <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>优点<ul>
<li>完全没有缩进,就像是在写同步代码</li>
</ul>
</li>
</ul>
<ol start="11">
<li>用 async 封装一个要骰子函数</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> 摇骰子(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果需要 reject,直接 throw Error(‘xxx’)</p>
</li>
<li><p>使用</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> fn()&#123;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> 摇骰子()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>如果需要处理错误，可以 try catch</p>
</li>
<li><p>async 的用法</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> 摇骰子(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>) + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="keyword">await</span> 摇骰子();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn();</span><br></pre></td></tr></table></figure>

<ul>
<li>需要注意如果 api 不是 promise，不能用 await</li>
<li>用 async/await 实现等三秒要骰子会非常麻烦</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> 摇骰子(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      resolve(<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">6</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> result = <span class="keyword">await</span> 摇骰子();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn();</span><br></pre></td></tr></table></figure>

<ul>
<li><p>总结:await 好是好，但是只能和 promise 搭配如果没有，那就需要自己封装 promise</p>
</li>
<li><p>async/await 捕获错误</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> 摇骰子(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"骰子坏了"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="keyword">await</span> 摇骰子();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fn();</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>为什么需要 async</li>
</ol>
<ul>
<li>看起来非常多余，await 所在函数就是 async，不是么？</li>
<li>在 await 发布之前有些人已经自己模拟了 await,为了兼容就代码普通函数里的 await(xxx)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function fn()&#123;</span><br><span class="line">  var result &#x3D; await(摇骰子())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>await 错误处理</li>
</ol>
<ul>
<li>常见</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> response;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  response = <span class="keyword">await</span> axios.get(<span class="string">"/xxx"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">if</span> (e.response) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e.response.status);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(response);</span><br></pre></td></tr></table></figure>

<ul>
<li>一个字:丑</li>
<li>正确做法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> response = <span class="keyword">await</span> axios.get(<span class="string">"/xxx"</span>).then(<span class="literal">null</span>, errorHandler);</span><br><span class="line"><span class="built_in">console</span>.log(response);</span><br></pre></td></tr></table></figure>

<ul>
<li>细节<ul>
<li>可以把 4xx/5xx 等常见错误用拦截器全局处理</li>
<li>await 只用关心成功，失败全部交给 errorHandler</li>
<li>errorHandler 也可以放在拦截器里</li>
<li>举例</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ajax = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// reject(&#123;</span></span><br><span class="line">    <span class="comment">//   response: &#123;</span></span><br><span class="line">    <span class="comment">//     status: 403,</span></span><br><span class="line">    <span class="comment">//   &#125;,</span></span><br><span class="line">    <span class="comment">// &#125;);</span></span><br><span class="line">    resolve(&#123;</span><br><span class="line">      data: &#123; <span class="attr">name</span>: <span class="string">"ories"</span> &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> error = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"提示用户没有权限"</span>);</span><br><span class="line">  <span class="keyword">throw</span> e;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> response = <span class="keyword">await</span> ajax().then(<span class="literal">null</span>, error);</span><br><span class="line">  <span class="built_in">console</span>.log(response);</span><br><span class="line">&#125;</span><br><span class="line">fn();</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>await 的传染性</li>
</ol>
<ul>
<li>代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">console.log(1)</span><br><span class="line">await console.log(2)</span><br><span class="line">console.log(3)</span><br></pre></td></tr></table></figure>

<ul>
<li>分析</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">console.log(3)变成异步任务了</span><br><span class="line">Promise 同样有传染性(同步变异步)</span><br><span class="line">谁没有传染性:回调</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>await 的应用场景</li>
</ol>
<ul>
<li>多次处理一个结果</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> r1 = <span class="keyword">await</span> makePromise();</span><br><span class="line"><span class="keyword">const</span> r2 = handleR1(r1);</span><br><span class="line"><span class="keyword">const</span> r3 = handleR2(r2);</span><br></pre></td></tr></table></figure>

<ul>
<li>串行<ul>
<li>天生串行</li>
<li>循环的时候有 bug(JS 又出了一个新东西来弥补)</li>
<li>for-await-of</li>
</ul>
</li>
<li>并行<ul>
<li>await Promise.all([p1,p2,p3])就是并行了</li>
</ul>
</li>
</ul>
<ol start="16">
<li>常见问题</li>
</ol>
<ul>
<li>async/await 是 promise 的语法糖，如何用 promise 实现 async/await<ul>
<li>答:有的语法糖好改写，有的语法糖不好改写。这个语法糖就不好改写，因为这是语言层面的改动，而不是 API 层面的。</li>
</ul>
</li>
<li>有些 await 需要等待上一个 await 的结果，有些不用，如何让不用同步的 await 异步进行<ul>
<li>答: 虽然解法很简单，但好像很多人都不知道,改变执行顺序就行。</li>
</ul>
</li>
<li>代码题</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> test = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  a = (<span class="built_in">console</span>.log(<span class="string">"a:"</span> + a), a) + (<span class="keyword">await</span> <span class="number">10</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(a);</span><br><span class="line">&#125;;</span><br><span class="line">test();</span><br><span class="line"><span class="built_in">console</span>.log(++a);</span><br><span class="line"><span class="comment">// 1 10,用加号,考点在于await左边并非都是后执行,a+即使在await左边也要先算</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/30/sketch%E5%AD%A6%E4%B9%A000/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/30/sketch%E5%AD%A6%E4%B9%A000/" class="post-title-link" itemprop="url">sketch学习00</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-30 10:11:34 / Modified: 13:10:56" itemprop="dateCreated datePublished" datetime="2020-08-30T10:11:34+08:00">2020-08-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">设计</span></a>
                </span>
            </span>

          
            <span id="/2020/08/30/sketch%E5%AD%A6%E4%B9%A000/" class="post-meta-item leancloud_visitors" data-flag-title="sketch学习00" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/30/sketch%E5%AD%A6%E4%B9%A000/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/30/sketch%E5%AD%A6%E4%B9%A000/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>sketch 界面布局插入工具详解</li>
</ol>
<ul>
<li><p>学习 SKETCH 里的界面布局，以及插入选项里的工具使用</p>
<ol>
<li>按空格进行拖动</li>
<li>按 z 进行放大，选择百分比进行放大缩小</li>
</ol>
</li>
<li><p>插入的使用</p>
<ol>
<li><img src="https://i.loli.net/2020/08/30/JQ6W3MV9K7CGxvr.png" alt="插入.png"></li>
<li>形状和矢量用得比较多</li>
<li>图片也可以直接拖进去</li>
<li>右键可以自定义工具栏把常用的放上去</li>
</ol>
</li>
</ul>
<ol start="2">
<li>sketch 画板与页面</li>
</ol>
<ul>
<li>置入选择画板,可以选择尺寸，也可以选择自定义尺寸并保存</li>
<li>画板勾选尺寸适配内容之后，里面元素会随着画板拉伸而拉伸</li>
<li>页面相当于一个不同的大的画板</li>
</ul>
<ol start="3">
<li>SKETCH 属性栏参数详解</li>
</ol>
<ul>
<li>点击变换可以进行自由变换</li>
<li>点击编辑，菜单也会发生变化,有断开连接，不对称等选项</li>
<li>点击旋转，可以变换中心点</li>
<li>填充可以选择渐变，可以在渐变线上点击添加新的点实现对颜色控制</li>
<li>填充可以进行叠加</li>
<li>模糊选项的使用</li>
</ul>
<ol start="4">
<li>SKETCH 文本样式共享样式</li>
</ol>
<ul>
<li><img src="https://i.loli.net/2020/08/30/RyUXzThvkYxunwc.png" alt="文字外观样式共享.png"></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/24/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9034js%E4%B8%93%E7%B2%BE03%E4%B9%8B%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/24/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9034js%E4%B8%93%E7%B2%BE03%E4%B9%8B%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D/" class="post-title-link" itemprop="url">高级前端养成34js专精03之手写深拷贝</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-24 21:23:23" itemprop="dateCreated datePublished" datetime="2020-08-24T21:23:23+08:00">2020-08-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-26 22:43:44" itemprop="dateModified" datetime="2020-08-26T22:43:44+08:00">2020-08-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js%E4%B8%93%E7%B2%BE/" itemprop="url" rel="index"><span itemprop="name">js专精</span></a>
                </span>
            </span>

          
            <span id="/2020/08/24/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9034js%E4%B8%93%E7%B2%BE03%E4%B9%8B%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成34js专精03之手写深拷贝" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/24/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9034js%E4%B8%93%E7%B2%BE03%E4%B9%8B%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/24/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9034js%E4%B8%93%E7%B2%BE03%E4%B9%8B%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>什么是深拷贝?</li>
</ol>
<ul>
<li>简单理解<ul>
<li>b 是 a 的一份拷贝，b 中没有对 a 中对象的引用</li>
</ul>
</li>
<li>另一种理解<ul>
<li>b 是 a 的一份拷贝</li>
<li>把 a 和 b 各画出图，a 与 b 没有链接</li>
<li><img src="https://i.loli.net/2020/08/24/Y2iBP9FtHpQ5Nnr.png" alt="深拷贝.png"></li>
</ul>
</li>
</ul>
<ol start="2">
<li>如何答题</li>
</ol>
<ul>
<li>步骤<ul>
<li>询问数据类型,比如用户数据，字符串，数字，有没有函数,symbol</li>
<li>询问数据规模，比如十万个属性，十万层嵌套</li>
<li>询问性能要求，时间要求，空间要求,n^2,2mb 以内</li>
<li>询问运行环境,chrome 运行，ie,nodejs 运行</li>
<li>询问其他要求,有没有其他需要告诉我的</li>
<li>开始写</li>
</ul>
</li>
</ul>
<ol start="3">
<li>最简单的办法</li>
</ol>
<ul>
<li>JSON 序列化和反序列化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var a &#x3D; &#123;</span><br><span class="line">  b: 1,</span><br><span class="line">  c: [1,2,3],</span><br><span class="line">  d: &#123;d1: &#39;dd1&#39;,d2:&#39;d3&#39;&#125;</span><br><span class="line">&#125;</span><br><span class="line">var a2 &#x3D; JSON.parse(JSON.stringify(a))</span><br></pre></td></tr></table></figure>

<ul>
<li>缺点<ul>
<li>不支持函数，直接忽略函数</li>
<li>不支持 undefined,支持 null</li>
<li>不支持引用</li>
<li>不支持 date,会把 date 变成 ios8601 的字符串</li>
<li>不支持正则，正则会变成空对象</li>
<li>不支持 symbol</li>
</ul>
</li>
</ul>
<ol start="4">
<li>递归克隆</li>
</ol>
<ul>
<li>思路<ul>
<li>递归<ul>
<li>看节点类型(七种)</li>
<li>如果基本类型就直接拷贝</li>
<li>如果是 object 就分情况讨论</li>
</ul>
</li>
<li>object 分为<ul>
<li>普通 object-for in?</li>
<li>数组 array-Array 初始化</li>
<li>函数 function-怎么拷贝?壁报</li>
<li>日期 Date-怎么拷贝？</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="5">
<li>开始干</li>
</ol>
<ul>
<li>步骤<ul>
<li>创建目录</li>
<li>引入 chai 和 sinon</li>
<li>开始驱动测试开发</li>
<li>测试失败=&gt;改代码=&gt;测试成功=&gt;加测试=&gt;测试失败</li>
</ul>
</li>
</ul>
<ol start="6">
<li>解决环的问题</li>
</ol>
<ul>
<li><img src="https://i.loli.net/2020/08/26/zHsoX79TLVt4SnQ.png" alt="解决环的问题.png"></li>
<li><img src="https://i.loli.net/2020/08/26/X17RqYEhmjVwa5O.png" alt="解决环的问题2.png"></li>
</ul>
<ol start="7">
<li>其他方式</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">immutable.js</span><br><span class="line">immer.js</span><br><span class="line">lodash.deepclone()</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><a href="https://github.com/codingories/34deepclone" target="_blank" rel="noopener">相关代码</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/23/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9033js%E4%B8%93%E7%B2%BE02%E4%B9%8BJS%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/23/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9033js%E4%B8%93%E7%B2%BE02%E4%B9%8BJS%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" class="post-title-link" itemprop="url">高级前端养成33js专精02之JS代码规范</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-23 20:51:29" itemprop="dateCreated datePublished" datetime="2020-08-23T20:51:29+08:00">2020-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-24 21:17:42" itemprop="dateModified" datetime="2020-08-24T21:17:42+08:00">2020-08-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js%E4%B8%93%E7%B2%BE/" itemprop="url" rel="index"><span itemprop="name">js专精</span></a>
                </span>
            </span>

          
            <span id="/2020/08/23/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9033js%E4%B8%93%E7%B2%BE02%E4%B9%8BJS%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成33js专精02之JS代码规范" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/23/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9033js%E4%B8%93%E7%B2%BE02%E4%B9%8BJS%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/23/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9033js%E4%B8%93%E7%B2%BE02%E4%B9%8BJS%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>业界参考</li>
</ol>
<ul>
<li><a href="https://google.github.io/styleguide/jsguide.html" target="_blank" rel="noopener">谷歌 JS 代码规范</a></li>
<li><a href="https://lin-123.github.io/javascript/" target="_blank" rel="noopener">Airbnb JS 代码规范</a></li>
<li><a href="https://standardjs.com/rules-zhcn" target="_blank" rel="noopener">JS 标准代码样式</a></li>
</ul>
<ol start="2">
<li>参考资料</li>
</ol>
<ul>
<li><a href="https://coolshell.cn/articles/4758.html" target="_blank" rel="noopener">如何写出无法维护的代码</a><ul>
<li>如果不知道什么是坏的，那也不知道什么是好的</li>
</ul>
</li>
<li><a href="https://dev.to/checkgit/the-joel-test-20-years-later-1kjk" target="_blank" rel="noopener">The Joel Test</a><ul>
<li>StackOverflow 创始人总结的技术团队衡量标准</li>
<li>如何衡量一个技术团队好还是不好，这篇文章告诉你</li>
</ul>
</li>
<li><a href="https://www.youtube.com/watch?v=DxnYQRuLX7Q" target="_blank" rel="noopener">视频: The better parts</a><ul>
<li>Douglas Crockford 阐述他认为 JS 中好的特性有哪些，坏的特性有哪些</li>
</ul>
</li>
</ul>
<ol start="3">
<li>好的 JS 代码原则目录</li>
</ol>
<ul>
<li>质量意识</li>
<li>语言特性</li>
<li>命名</li>
<li>注释</li>
<li>lint</li>
</ul>
<ol start="4">
<li>质量意识</li>
</ol>
<ul>
<li>一些错误但大行其道的观点<ul>
<li>我们没有时间写单元测试</li>
<li>应该给每一行代码加注释</li>
<li>代码中的空格，括号非常重要</li>
<li>等我们有时间了再重构</li>
<li>只要坑挖得足够多的，就可以筑起护城河</li>
<li>测试是测试人员的事情，跟开发没关系</li>
</ul>
</li>
<li>错再哪<ul>
<li>没时间写测试，有时间改 bug</li>
<li>正确地写注释，注释 why 而不是注释 how</li>
<li>空格，括号远没有那么重要</li>
<li>重构是要每天进行的</li>
<li>只要坑挖得足够深，头发就会掉得更快</li>
<li>应该能独立保证自己的代码质量，不要完全依赖测试人员</li>
</ul>
</li>
</ul>
<ol start="5">
<li>现状</li>
</ol>
<ul>
<li>人员水平<ul>
<li>大部分程序对质量的提升方法是堆时间(加班)</li>
<li>正确的办法是自动化，监控，预警</li>
<li>大部分前端对代码质量还停留在 Lint 工具</li>
<li>正确的做法是静态分析，单元测试，不断重构</li>
</ul>
</li>
<li>需要做的<ul>
<li>不要被错误的观点同化</li>
<li>相信<code>一切能用机器做的事情，都应该交给机器做</code></li>
<li>一旦有实践自动化，测试的可能，就勇敢地上</li>
</ul>
</li>
</ul>
<ol start="6">
<li><p>JS 语言特性-语言提供给我们的各种功能</p>
<ul>
<li>道格拉斯的观点<ul>
<li>如果一个特性有时好用有时危险，还有一个更好的选项，那么我们总是应该使用那个更好的</li>
<li>公司雇我们不是为了让我们使用语言的每个特性，而是让我们写出可以用的代码，并且避免错误</li>
</ul>
</li>
</ul>
</li>
<li><p>程序员的共识</p>
</li>
</ol>
<ul>
<li>1960 年代，我们花了一代人的时间去认同<ul>
<li><a href="https://en.wikipedia.org/wiki/High-level_programming_language" target="_blank" rel="noopener">高级语言是好的</a>(反方: 机器语言效率高)</li>
</ul>
</li>
<li>1970 年代，我们花了一代人的时间去认同<ul>
<li><a href="https://zh.wikipedia.org/zh-cn/%E7%BB%93%E6%9E%84%E5%8C%96%E7%BC%96%E7%A8%8B" target="_blank" rel="noopener">goto 是不好的</a>，支持结构化编程</li>
</ul>
</li>
<li>1980 年代，我们花了一代人的时间去认同<ul>
<li><a href="https://zh.wikipedia.org/zh-cn/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%23%E5%8E%86%E5%8F%B2" target="_blank" rel="noopener">对象是好的</a>，发展面向对象</li>
</ul>
</li>
<li>1990 年代，我们花了两代人的时间去认同<ul>
<li>lambda 表达式是好的(Java,C++,PHP,JS 加强支持)</li>
</ul>
</li>
</ul>
<ol start="8">
<li><del>存在即合理</del></li>
</ol>
<ul>
<li>错误，有些就是不合理，比如 var 和==</li>
</ul>
<ol start="9">
<li><del>代码越短越好</del></li>
</ol>
<ul>
<li>错误， <code>无歧义</code>优于<code>简洁</code></li>
</ul>
<ol start="10">
<li>JS 代码中的特性取舍</li>
</ol>
<ul>
<li>用哪些?不用哪些？</li>
<li>能完成特定功能无歧义，无副作用<ul>
<li>这样的特性，优先使用</li>
</ul>
</li>
</ul>
<ol start="11">
<li>不要用的 JS 特性</li>
</ol>
<ul>
<li>绝对不要用<ul>
<li>全局变量</li>
<li>var 声明</li>
<li>==运算符</li>
<li>包装类型 String/Boolean</li>
</ul>
</li>
<li>有些人不用<ul>
<li>class/new/this</li>
<li>比如 React Hooks 那帮人</li>
</ul>
</li>
<li>用的人不多，尽量少用<ul>
<li>symbol,generator,iterator</li>
<li>反射</li>
</ul>
</li>
</ul>
<ol start="12">
<li>推荐使用的 JS 特性</li>
</ol>
<ul>
<li><p>一定要用</p>
<ul>
<li>=== 全等</li>
<li>…三个点运算符</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 余下操作符</span><br><span class="line">let a &#x3D; [1,2,3,4,5]</span><br><span class="line">let [_1,_2,...rest]&#x3D;a  &#x2F;&#x2F; _1,_2可以不写，只是占位置</span><br><span class="line">rest &#x2F;&#x2F; [3,4,5]</span><br><span class="line">function add(...numbers)&#123;</span><br><span class="line">  return numbers.reduce((sum,n)&#x3D;&gt;sum+n,0)</span><br><span class="line">&#125;</span><br><span class="line">add(1,2,3) &#x2F;&#x2F; 6</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 扩展运算符</span><br><span class="line">let a2 &#x3D; [1,2,3]</span><br><span class="line">let a3 &#x3D; a2</span><br><span class="line">let a4 &#x3D; [...a2]</span><br><span class="line">a4 &#x3D;&#x3D;&#x3D; a2 &#x2F;&#x2F; false</span><br><span class="line">a3 &#x3D;&#x3D;&#x3D; a2 &#x2F;&#x2F; true</span><br></pre></td></tr></table></figure>

<ul>
<li>模块 import export</li>
<li>let 和 const,优先使用 const</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">  function f()&#123;</span><br><span class="line">    var n &#x3D; arguments[0] &#x2F;&#x2F; 实际就是f(n)</span><br><span class="line">    if(n&#x3D;&#x3D;&#x3D;0) return 0</span><br><span class="line">    if(n&#x3D;&#x3D;&#x3D;1) return 1</span><br><span class="line">    return f(n-1)+f(n-2)</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; 写成下面这种形式</span><br><span class="line">let f &#x3D; (n)&#x3D;&gt;&#123;</span><br><span class="line">    var n &#x3D; arguments[0]</span><br><span class="line">    if(n&#x3D;&#x3D;&#x3D;0) return 0</span><br><span class="line">    if(n&#x3D;&#x3D;&#x3D;1) return 1</span><br><span class="line">    return f(n-1)+f(n-2)</span><br><span class="line">  &#125;</span><br><span class="line">&#x2F;&#x2F; 去掉花括号</span><br><span class="line">let f &#x3D; n&#x3D;&gt;</span><br><span class="line">n &#x3D;&#x3D;&#x3D; 0?0:n&#x3D;&#x3D;&#x3D;1?1:f(n-1)+f(n-2)</span><br></pre></td></tr></table></figure>

<ul>
<li>析构赋值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let a &#x3D; 1; let b &#x3D; 2;</span><br><span class="line">[a,b]&#x3D;[b,a]</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Promise/await</p>
</li>
<li><p>可以使用</p>
<ul>
<li>class</li>
<li>getter/setter</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">let person &#x3D; &#123;</span><br><span class="line">  姓: &#39;李&#39;,</span><br><span class="line">  名: &#39;白&#39;,</span><br><span class="line">  get name()&#123;</span><br><span class="line">    return this.姓 + this.名</span><br><span class="line">  &#125;,</span><br><span class="line">  set name(value)&#123;</span><br><span class="line">    this.姓 &#x3D; value[0]</span><br><span class="line">    this.名 &#x3D; value.substring(1)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">person.name &#x3D; &#39;杜甫&#39;</span><br><span class="line">person &#x2F;&#x2F; &#123;姓:&#39;杜&#39;,名:&#39;甫&#39;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>WeakMap,代替 symbol</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 经典去重</span><br><span class="line">var a &#x3D; [1,3,5,3,2,1]</span><br><span class="line">new Set(a)</span><br><span class="line">[...new Set(a)]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 如果不用set</span><br><span class="line">var hash &#x3D; new WeakMap()</span><br><span class="line">let obj &#x3D; &#123;name:&#39;frank&#39;&#125;</span><br><span class="line">hash.set(obj,1)</span><br><span class="line">hash.has(obj) &#x2F;&#x2F; true</span><br><span class="line">hash.get(obj) &#x2F;&#x2F; 1</span><br><span class="line">&#x2F;&#x2F; WeakMap不会出现内存泄漏</span><br></pre></td></tr></table></figure>

<ul>
<li>Proxy,Vue3 核心取代 defineProperty</li>
<li>存在问题但可用<ul>
<li>箭头函数</li>
<li>数组 API+Polyfill,<a href="https://fangyinghang.com/es-6-tutorials/" target="_blank" rel="noopener">参考资料</a></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 把伪数组变真数组</span><br><span class="line">Array.from(tagList)</span><br><span class="line">&#x2F;&#x2F; 以前用</span><br><span class="line">&#x2F;&#x2F; Array.prototype.slice.call(tagList,0)</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>命名</li>
</ol>
<ul>
<li>坏命名示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">let xiaoliang</span><br><span class="line">let user &#x3D; [&#123;id:1,name:&#39;f&#39;&#125;,&#123;id:2,name:&#39;j&#39;&#125;] &#x2F;&#x2F; users</span><br><span class="line">let flag &#x3D; true &#x2F;&#x2F; visibleFlag</span><br><span class="line">let userInfo &#x3D; &#123;id:1,name:&#39;f&#39;&#125; &#x2F;&#x2F; 不要+Info,userData,userInfo，userInformation都是错的,所有变量都是info</span><br><span class="line">let handler &#x3D; (x)&#x3D;&gt;&#123;console.log(x)&#125; &#x2F;&#x2F; 所有的函数都handler</span><br><span class="line">&#x2F;&#x2F; 以上三个共同错误，叫的名称太抽象，不如不叫</span><br><span class="line">let cnt &#x3D; document.querySelector(&#39;#test&#39;)</span><br><span class="line">let idx &#x3D; 0</span><br><span class="line">let cur &#x3D; 0</span><br><span class="line">&#x2F;&#x2F; 以上缩写问题</span><br></pre></td></tr></table></figure>

<ul>
<li>首要规则，命名应该让人秒懂</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function user(userId)&#123;</span><br><span class="line">  return axios.get(&#96;&#x2F;users&#x2F;$&#123;userId&#125;&#96;)</span><br><span class="line">    .then((res)&#x3D;&gt;&#123;</span><br><span class="line">      console.log(res.data)</span><br><span class="line">    &#125;,handlerError)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; 以上代码基本没啥问题，下面更好</span><br><span class="line">user.get &#x3D; (id) &#x3D;&gt; [</span><br><span class="line">  return axios.get(&#96;&#x2F;user&#x2F;$&#123;id&#125;&#96;)</span><br><span class="line">    .then((response)&#x3D;&gt;&#123;</span><br><span class="line">      console.log(response.data)</span><br><span class="line">    &#125;, onGetUserError)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>命名应该符合英语习惯<ul>
<li>普通变量用名词</li>
<li>复数要加 s 或者对应复数形式</li>
<li>布尔用 isXXX 或 canXXX 或形容词</li>
<li>静止用 showDialog 表示是否展示 dialog</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">isDialogSeen</span><br><span class="line">canClick</span><br><span class="line">clickable</span><br></pre></td></tr></table></figure>

<ul>
<li>普通函数用动词开头</li>
<li>钩子函数用介词加动词开头</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onError</span><br><span class="line">onLoad</span><br></pre></td></tr></table></figure>

<ul>
<li><p>容易混淆的对象加前缀，如$div</p>
</li>
<li><p>命名不准用缩写</p>
<ul>
<li>如 cnt/idx/cur/prev/anal</li>
<li>某些特定的缩写可以用，比如 for 循环里面的 ijk</li>
<li>行业通用缩写当作</li>
</ul>
</li>
<li><p>注释分类</p>
<ul>
<li>对代码进行翻译的注释</li>
<li>对代码进行总结的注释</li>
<li>对 bug 进行分析的注释</li>
<li>对参考来源的注释</li>
<li>对潜在问题的警告的注释</li>
<li>发泄情绪的注释</li>
</ul>
</li>
</ul>
<ol start="14">
<li>推荐工具</li>
</ol>
<ul>
<li>lint 工具<ul>
<li>eslint</li>
<li>Standard JS</li>
<li>不推荐 jslint/jscs/jshint</li>
</ul>
</li>
<li>推荐配置(也不是那么推荐)<ul>
<li>eslint-config-Airbnb</li>
</ul>
</li>
<li>建议<ul>
<li>不要那么在意空格，括号</li>
<li>请关注命名，代码解构，单元测试</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/16/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9027%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B09%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-Nginx-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/16/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9027%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B09%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-Nginx-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">高级前端养成27博客系统之09博客系统之自动化部署+Nginx+项目总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-16 10:41:24" itemprop="dateCreated datePublished" datetime="2020-08-16T10:41:24+08:00">2020-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-17 23:36:36" itemprop="dateModified" datetime="2020-08-17T23:36:36+08:00">2020-08-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">运维部署 博客系统</span></a>
                </span>
            </span>

          
            <span id="/2020/08/16/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9027%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B09%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-Nginx-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成27博客系统之09博客系统之自动化部署+Nginx+项目总结" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/16/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9027%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B09%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-Nginx-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/16/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9027%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B09%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2-Nginx-%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>开启服务器</li>
<li>开启 psql 容器 docker restart xxx</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 删掉其它不相关容器</span><br><span class="line">docker system prune</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>更新代码 git stash;git pull;git stash pop; yarn build;</li>
</ol>
<ul>
<li>yarn install –production=false</li>
<li>yarn build</li>
<li>docker build -t fang/node-web-app .</li>
<li>docker run –network=host -p 3000:3000 -d fang/node-web-app</li>
<li>出现错误，要把.dockerignore 中的.env.local 删掉</li>
</ul>
<ol start="4">
<li>构建 app 容器 docker build</li>
<li>开启 app 容器 docker run</li>
<li>自动化部署脚本</li>
</ol>
<ul>
<li>ssh 远程自动执行脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1 &quot;echo hi &gt; &#x2F;tmp&#x2F;frank&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>新建/bin/deploy.sh</li>
<li>chmod +x bin/deploy.sh</li>
<li>上传代码</li>
<li>ssh blog@dev1 ‘sh /home/blog/app/23createBlogs/bin/deploy.sh’</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker start 534 &amp;&amp;</span><br><span class="line">cd &#x2F;home&#x2F;blog&#x2F;app&#x2F; &amp;&amp;</span><br><span class="line">git pull &amp;&amp;</span><br><span class="line">yarn install --production&#x3D;false</span><br><span class="line">yarn build &amp;&amp;</span><br><span class="line">docker build -t fang&#x2F;node-web-app . &amp;&amp;</span><br><span class="line">docker run --name app --network&#x3D;host -p 3000:3000 -d fang&#x2F;node-web-app &amp;&amp;</span><br><span class="line">echo &#39;OK!&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 处理目录</span><br><span class="line">&lt;!-- mv -f 23createBlogs&#x2F;* .&#x2F; --&gt;</span><br><span class="line">&lt;!-- mv -f 23createBlogs&#x2F;.* .&#x2F; --&gt;</span><br><span class="line">&#x2F;&#x2F; . 和..是虚拟目录不用管</span><br><span class="line">&lt;!-- rm -rf 23createBlogs --&gt;</span><br><span class="line">ssh blog@dev1 &#39;sh &#x2F;home&#x2F;blog&#x2F;app&#x2F;bin&#x2F;deploy.sh&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>通过软连接和 gitignore 解决环境配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv app&#x2F;ormconfig.json .&#x2F;shared&#x2F;</span><br><span class="line">ln -s ..&#x2F;shared&#x2F;ormconfig.json</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 git diff 创建补丁</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; git create patch file from diff</span><br><span class="line">git diff &gt; migrate.patch&#39;</span><br><span class="line">git apply migrate.patch</span><br></pre></td></tr></table></figure>

<ul>
<li>最后的部署脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">docker start app &amp;&amp;</span><br><span class="line">cd &#x2F;home&#x2F;blog&#x2F;app&#x2F; &amp;&amp;</span><br><span class="line">git pull &amp;&amp;</span><br><span class="line">yarn install --production&#x3D;false</span><br><span class="line">yarn build &amp;&amp;</span><br><span class="line">git apply migrate.patch;</span><br><span class="line">yarn compile &amp;&amp;</span><br><span class="line">yarn m:run &amp;&amp;</span><br><span class="line">git reset --hard HEAD &amp;&amp;</span><br><span class="line">docker build -t fang&#x2F;node-web-app . &amp;&amp;</span><br><span class="line">docker kill app &amp;&amp;</span><br><span class="line">docker rm app &amp;&amp;</span><br><span class="line">docker run --name app --network&#x3D;host -p 3000:3000 -d fang&#x2F;node-web-app &amp;&amp;</span><br><span class="line">echo &#39;OK!&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>解决 pull push 的问题，通过远程执行本地的脚本, push 是不能省的</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1 &#39;bash -s&#39; &lt; bin&#x2F;deploy.sh</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>使用 nginx</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nginx只用于静态内容</span><br><span class="line">动态内容转发</span><br></pre></td></tr></table></figure>

<ul>
<li>首先要找 docker nginx 容器<ul>
<li>没有写–net=host 的时候的情况，桥接模式<ul>
<li><img src="https://i.loli.net/2020/08/17/sSFnePOQXNRBJ1L.png" alt="桥接模式.png"></li>
</ul>
</li>
<li>写了–net=host 的情况，可以直接访问端口<ul>
<li><img src="https://i.loli.net/2020/08/17/RKy1e3hTsj57Hvu.png" alt="直接访问.png"></li>
</ul>
</li>
<li>使用 ngnix 的好处<ul>
<li>动静分离,让静态服务更快</li>
<li>起多个服务，服务不中断</li>
<li>反向代理，负载均衡铺垫，扩展性</li>
</ul>
</li>
<li><a href="https://hub.docker.com/_/nginx" target="_blank" rel="noopener">相关文档</a></li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh blog@dev1</span><br><span class="line">&#x2F;&#x2F; -d 长久的运行</span><br><span class="line">$ docker run --name nginx1 --network&#x3D;host -d nginx:1.19.1</span><br></pre></td></tr></table></figure>

<ul>
<li>nginx 初步使用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        listen  [::]:80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location ~ ^&#x2F;_next&#x2F;static&#x2F;  &#123;</span><br><span class="line">          root  &#x2F;home&#x2F;blog&#x2F;app&#x2F;.next&#x2F;static&#x2F;;</span><br><span class="line">          expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;0.0.0.0:3000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 nginx,搜索 nginx full example</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx1 --network&#x3D;host -v &#x2F;home&#x2F;blog&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf -d nginx:1.19.1</span><br></pre></td></tr></table></figure>

<ul>
<li>完善 nginx 启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name nginx1 --network&#x3D;host -v &#x2F;home&#x2F;blog&#x2F;nginx.conf:&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;default.conf -v &#x2F;home&#x2F;blog&#x2F;app&#x2F;.next&#x2F;static&#x2F;:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;_next&#x2F;static -d nginx:1.19.1</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 gzip</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">listen 80;</span><br><span class="line">listen [::]:80;</span><br><span class="line">server_name localhost;</span><br><span class="line">        location ~ ^&#x2F;_next&#x2F;static&#x2F;  &#123;</span><br><span class="line">          root  &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;;</span><br><span class="line">          expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line">        gzip on;</span><br><span class="line">        gzip_disable &quot;msie6&quot;;</span><br><span class="line">        gzip_vary on;</span><br><span class="line">        gzip_proxied any;</span><br><span class="line">        gzip_comp_level 6;</span><br><span class="line">        gzip_buffers 16 8k;</span><br><span class="line">        gzip_http_version 1.1;</span><br><span class="line">        gzip_min_length 256;</span><br><span class="line">        gzip_types</span><br><span class="line">            text&#x2F;plain</span><br><span class="line">            text&#x2F;css</span><br><span class="line">            application&#x2F;json</span><br><span class="line">            application&#x2F;javascript</span><br><span class="line">            application&#x2F;x-javascript</span><br><span class="line">            text&#x2F;xml</span><br><span class="line">            application&#x2F;xml</span><br><span class="line">            application&#x2F;xml+rss</span><br><span class="line">            text&#x2F;javascript</span><br><span class="line">            application&#x2F;vnd.ms-fontobject</span><br><span class="line">            application&#x2F;x-font-ttf</span><br><span class="line">            font&#x2F;opentype</span><br><span class="line">            image&#x2F;svg+xml</span><br><span class="line">            image&#x2F;x-icon;</span><br><span class="line">        location &#x2F; &#123;</span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;0.0.0.0:3000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>总结博客项目</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/15/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9026%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B08%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/15/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9026%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B08%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">高级前端养成26博客系统之08细节优化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-15 09:53:04" itemprop="dateCreated datePublished" datetime="2020-08-15T09:53:04+08:00">2020-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-16 10:29:55" itemprop="dateModified" datetime="2020-08-16T10:29:55+08:00">2020-08-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">博客系统</span></a>
                </span>
            </span>

          
            <span id="/2020/08/15/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9026%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B08%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成26博客系统之08细节优化" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/15/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9026%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B08%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/15/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9026%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B08%E7%BB%86%E8%8A%82%E4%BC%98%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>创建 logo</li>
</ol>
<ul>
<li>通过在 google 搜索 logo generator 创建 logo</li>
<li>下载 <code>paint.net</code> 编辑 log</li>
</ul>
<ol start="2">
<li>修改首页的 css</li>
<li>修改文章列表 css</li>
<li>修改文章详情 css</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">把vue介绍readme 提交上去</span><br><span class="line">yarn add github-markdown-css</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>添加文章详情 css</li>
<li>添加新增博客入口</li>
<li>添加编辑入口</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add classnames</span><br><span class="line">yarn add --dev @types&#x2F;classnames</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>完善页面 css</li>
<li>创建编辑页面</li>
<li>其它增删改查<ul>
<li>AJAX 思路</li>
<li>传统页面思路</li>
</ul>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9025%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B07%E9%83%A8%E7%BD%B2%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9025%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B07%E9%83%A8%E7%BD%B2%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91/" class="post-title-link" itemprop="url">高级前端养成25博客系统之07部署到阿里云</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-11 20:06:27" itemprop="dateCreated datePublished" datetime="2020-08-11T20:06:27+08:00">2020-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-07 20:54:42" itemprop="dateModified" datetime="2020-11-07T20:54:42+08:00">2020-11-07</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BF%90%E7%BB%B4%E9%83%A8%E7%BD%B2-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">运维部署 博客系统</span></a>
                </span>
            </span>

          
            <span id="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9025%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B07%E9%83%A8%E7%BD%B2%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成25博客系统之07部署到阿里云" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9025%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B07%E9%83%A8%E7%BD%B2%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9025%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B07%E9%83%A8%E7%BD%B2%E5%88%B0%E9%98%BF%E9%87%8C%E4%BA%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li><p>过程导览</p>
<ol>
<li>Docker 化我们的应用</li>
<li>买一个按使用量收费的服务器(100 元起步)</li>
<li>上传 ssh pub key</li>
<li>创建一个用户 blog，分配目录/home/blog</li>
<li>创建 app 目录，app 里包含 current 和 releases 两个子目录
a) 其中 releases 用来容纳每一次发布
b) 其中 current 用来 link 到最新的发布</li>
</ol>
</li>
<li><p>确定在 docker 化之前代码是可以用的，解决 post 类型问题</p>
</li>
</ol>
<ul>
<li>由于之前 ext-env.d.ts 有了 import 所以不是全局的了</li>
<li>解决方法:最外层新建 custom.d.ts 把类型放入</li>
</ul>
<ol start="3">
<li>docker 化 node 应用</li>
</ol>
<ul>
<li>google 搜索 docker nodejs,找到<a href="https://nodejs.org/en/docs/guides/nodejs-docker-webapp/" target="_blank" rel="noopener">文档</a></li>
<li><code>docker build -t fang/node-web-app .</code>,创建操作系统镜像</li>
<li><code>docker run -p 3000:3000 -d fang/node-web-app</code> ,使用操作系统镜像,左边为操作系统端口，右边镜像端口</li>
<li>docker logs b45</li>
<li>出现问题.env.secret 不能给别人看，修改 .dockerignore</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.local</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用 ssh 登录服务器</li>
</ol>
<ul>
<li>刚开始需要输入密码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh root@39.103.166.176</span><br><span class="line">Jirengu2020</span><br></pre></td></tr></table></figure>

<ul>
<li>copy 本机 ssh 到服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id root@39.103.166.176</span><br><span class="line">Jirengu2020</span><br></pre></td></tr></table></figure>

<ul>
<li>此时 ssh <a href="mailto:&#114;&#111;&#x6f;&#116;&#x40;&#x33;&#57;&#x2e;&#x31;&#48;&#x33;&#x2e;&#49;&#x36;&#x36;&#x2e;&#x31;&#x37;&#x36;">&#114;&#111;&#x6f;&#116;&#x40;&#x33;&#57;&#x2e;&#x31;&#48;&#x33;&#x2e;&#49;&#x36;&#x36;&#x2e;&#x31;&#x37;&#x36;</a> 就不需要密码了</li>
<li>linux 密码设置 <code>passwd root</code></li>
<li>别人想要服务器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;.ssh</span><br><span class="line">cat authorized_keys</span><br></pre></td></tr></table></figure>

<ul>
<li>如何让其它人也能登录机器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">新开一个 把其他人机器的~&#x2F;.ssh&#x2F;id_rsa.pub</span><br><span class="line">复制到到root的authorized_keys下面</span><br><span class="line">vi authorized_keys</span><br><span class="line">按o粘贴别人机器的key</span><br><span class="line">按q退出，不会vi，就用vimtutor学一下</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>为应用单独创建 user</p>
<ul>
<li>root 权限太大了，不要用 root</li>
<li>每次输入 ip 太麻烦，编辑 host 把公网 ip 放进去,39.103.166.176 dev1</li>
<li>然后就可以 root@dev1 进入</li>
<li>然后新建 user,<code>adduser blog</code>,输入密码创建成功</li>
<li>如何登入 blog 方法一 su - blog</li>
<li>方法二 登录 blog ssh blog@dev1，输入密码成功登录</li>
<li>但是这样子每次输入密码很烦，同样 ssh-copy-id 上传上去，输入密码就不需要输入密码了</li>
<li>同样改密码,passwd blog</li>
</ul>
</li>
<li><p>为 root 安装 docker</p>
<ul>
<li>google 搜索 ubuntu 10 install docker，找到<a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener">官方链接</a>,跟着做就可以</li>
<li></li>
</ul>
</li>
<li><p>将 blog 用户加到 docker 分组</p>
<ul>
<li>google 搜索 linux list all groups</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;etc&#x2F;group</span><br><span class="line">搜索linux add user to group</span><br><span class="line">切到root</span><br><span class="line">usermod -a -G docker blog</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><p>实现思路</p>
<ul>
<li>把代码拉到 blog 目录</li>
<li>根据代码再去创建 docker 镜像,然后运行 docker 镜像</li>
<li>好处是省去了上传 docker 镜像这一步</li>
</ul>
</li>
<li><p>开始下载代码</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 切到blog</span><br><span class="line">su - blog</span><br><span class="line">git --version</span><br><span class="line">pwd</span><br><span class="line">mkdir app</span><br><span class="line">cd app</span><br><span class="line">&#x2F;&#x2F; 需要添加earth&#x2F;dev1到github</span><br><span class="line">&#x2F;&#x2F; cat ~&#x2F;.ssh&#x2F;id 发现没有</span><br><span class="line">&#x2F;&#x2F; 搜索generate ssh key</span><br><span class="line">ssh-keygen -t rsa -b 4096 -C tellt@126.com</span><br><span class="line">&#x2F;&#x2F; cat ~&#x2F;.ssh&#x2F;id_rsa 然后复制到github</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>在阿里云上 build 应用</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir blog-data</span><br><span class="line">cd app&#x2F;</span><br><span class="line">cd</span><br></pre></td></tr></table></figure>

<ul>
<li>运行 readme</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   </span><br><span class="line">&#x2F;&#x2F; 构建镜像</span><br><span class="line">docker build -t fang&#x2F;node-web-app .</span><br><span class="line">&#x2F;&#x2F; 运行镜</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>在 ubuntu 上安装 node,yarn，<a href="https://github.com/nodesource/distributions/blob/master/README.md" target="_blank" rel="noopener">相关文档</a></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ubuntu install nodejs12</span><br><span class="line">curl -sL https:&#x2F;&#x2F;deb.nodesource.com&#x2F;setup_12.x | sudo -E bash -</span><br><span class="line">sudo apt-get install -y nodejs</span><br><span class="line"></span><br><span class="line">sudo apt-get install gcc g++ make</span><br><span class="line">curl -sL https:&#x2F;&#x2F;dl.yarnpkg.com&#x2F;debian&#x2F;pubkey.gpg | sudo apt-key add -</span><br><span class="line">echo &quot;deb https:&#x2F;&#x2F;dl.yarnpkg.com&#x2F;debian&#x2F; stable main&quot; | sudo tee &#x2F;etc&#x2F;apt&#x2F;sources.list.d&#x2F;yarn.list</span><br><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install yarn</span><br><span class="line">&#x2F;&#x2F; cd 到 app&#x2F;项目目录</span><br><span class="line">yarn install</span><br><span class="line">yarn build</span><br><span class="line">&#x2F;&#x2F; 构建镜像</span><br><span class="line">docker build -t fang&#x2F;node-web-app .</span><br><span class="line">&#x2F;&#x2F; 运行镜像</span><br><span class="line">docker run -p 3000:3000 -d fang&#x2F;node-web-app</span><br></pre></td></tr></table></figure>

<ul>
<li>发现报错，因为.env.local 文件没上传</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">touch .env.local</span><br><span class="line">vi .env.local</span><br><span class="line">&#x2F;&#x2F; 按 a，把内容复制进去</span><br><span class="line">esc,:wq</span><br></pre></td></tr></table></figure>

<ul>
<li>总结过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F; 创建数据库</span><br><span class="line">docker run -v &quot;\$PWD&#x2F;blog-data&quot;:&#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data -p 5432:5432 -e POSTGRES_USER&#x3D;blog -e POSTGRES_HOST_AUTH_METHOD&#x3D;trust -d postgres:12.2</span><br><span class="line">git clone xxxx</span><br><span class="line">cd xxx</span><br><span class="line">&#x2F;&#x2F; 获取最新代码</span><br><span class="line">git pull</span><br><span class="line">&#x2F;&#x2F; 获取最新依赖</span><br><span class="line">yarn install</span><br><span class="line">&#x2F;&#x2F; 得到可以执行代码</span><br><span class="line">yarn build</span><br><span class="line">&#x2F;&#x2F; touch .env,secret 然后用 docker 创建镜像，解决 build 报错</span><br><span class="line">docker build -t fang&#x2F;node-web-app .</span><br><span class="line">docker run</span><br><span class="line">curl localhost:3000</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>解决报错</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">docker kill</span><br><span class="line">docker rm &#x2F;&#x2F; 所有服务</span><br><span class="line">&#x2F;&#x2F; 重新运行 postgress</span><br><span class="line">&#x2F;&#x2F; 小技巧</span><br><span class="line">history | grep docker run</span><br><span class="line">docker run --network&#x3D;host -v &#x2F;home&#x2F;blog&#x2F;blog-data&#x2F;:&#x2F;var&#x2F;lib&#x2F;postgresql&#x2F;data -p 5432:5432 -e POSTGRES_USER&#x3D;blog -e POSTGRES_HOST_AUTH_METHOD&#x3D;trust -d postgres:12.2</span><br><span class="line">docker run --network&#x3D;host -p 3000:3000 -d fang&#x2F;node-web-app</span><br><span class="line">curl -L http:&#x2F;&#x2F;localhost:3000</span><br><span class="line">docker logs 0ee</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>在阿里云上创建数据库</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it 245 bash</span><br><span class="line">psql -U blog</span><br><span class="line">CREATE DATABASE blog_development ENCODING &#39;UTF8&#39; LC_COLLATE &#39;en_US.utf8&#39; LC_CTYPE &#39;en_US.utf8&#39;;</span><br><span class="line">whoami</span><br><span class="line">history | grep &#39;docker run&#39;</span><br><span class="line">docker run --network&#x3D;host -p 3000:3000 -d fang&#x2F;node-web-app</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>在阿里云上创建数据表</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vi ~&#x2F;.bashrc</span><br><span class="line">&#x2F;&#x2F;第一行</span><br><span class="line">export NODE_ENV&#x3D;production</span><br><span class="line">&#x2F;&#x2F; 改写</span><br><span class="line">database: process.env.NODE_ENV &#x3D;&#x3D;&#x3D; &#39;production&#39; ? &#39;blog_production&#39; : &#39;blog_development&#39;,</span><br><span class="line">yarn dev</span><br><span class="line">yarn m:run</span><br><span class="line">发现 json 做配置文件有问题，当前配置文件只是用来开发，最好用 js 做配置文件</span><br><span class="line">cp ormconfig.json ormconfig_production.json</span><br><span class="line">编辑 ormconfig.json 文件</span><br><span class="line">注释 src&#x2F;entity&#x2F;User.ts 中引入 getDatabaseConnection 的地方</span><br><span class="line">esc,shift+8 搜索下一个</span><br><span class="line">注释 5 行</span><br><span class="line">再 yarn m:run，就可以了</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>添加阿里云安全策略</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">更多</span><br><span class="line">网络安全组</span><br><span class="line">网络安全组配置</span><br><span class="line">手动添加</span><br><span class="line">0.0.0.0&#x2F;0</span><br><span class="line">3000</span><br></pre></td></tr></table></figure>

<ol start="16">
<li>别忘了关机</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实例</span><br><span class="line">停机-&gt;停机不收费</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9024%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B06%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9024%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B06%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5/" class="post-title-link" itemprop="url">高级前端养成24博客系统之06后端分页</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-11 20:06:18 / Modified: 20:07:51" itemprop="dateCreated datePublished" datetime="2020-08-11T20:06:18+08:00">2020-08-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">数据库 博客系统</span></a>
                </span>
            </span>

          
            <span id="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9024%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B06%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成24博客系统之06后端分页" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9024%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B06%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9024%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B06%E5%90%8E%E7%AB%AF%E5%88%86%E9%A1%B5/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>前端统一处理未登录</li>
</ol>
<ul>
<li>实现未登录发博客跳转到登录页</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ReactChild, useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line">import &#123;AxiosResponse&#125; from &#39;axios&#39;</span><br><span class="line"></span><br><span class="line">type Field&lt;T&gt; &#x3D; &#123;</span><br><span class="line">  label: string,</span><br><span class="line">  type: &#39;text&#39; | &#39;password&#39; | &#39;textarea&#39;,</span><br><span class="line">  key: keyof T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type useFormOptions&lt;T&gt; &#x3D; &#123;</span><br><span class="line">  initFormData: T;</span><br><span class="line">  fields: Field&lt;T&gt;[];</span><br><span class="line">  buttons: ReactChild;</span><br><span class="line">  submit: &#123;</span><br><span class="line">    request: (formData:T)&#x3D;&gt; Promise&lt;AxiosResponse&lt;T&gt;&gt;;</span><br><span class="line">    success: () &#x3D;&gt; void;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(options: useFormOptions&lt;T&gt;) &#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line">  const &#123;initFormData, fields, buttons, submit&#125; &#x3D; options</span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key)) &#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key: keyof T, value: any) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [formData])</span><br><span class="line"></span><br><span class="line">  const _onSubmit &#x3D; useCallback((e) &#x3D;&gt; &#123;</span><br><span class="line">    e.preventDefault() &#x2F;&#x2F; 调用外面submit</span><br><span class="line">    submit.request(formData).then(submit.success,(error)&#x3D;&gt;&#123;</span><br><span class="line">      if (error.response) &#123;</span><br><span class="line">        const response: AxiosResponse &#x3D; error.response</span><br><span class="line">        if (response.status &#x3D;&#x3D;&#x3D; 422) &#123;</span><br><span class="line">          setErrors(response.data)</span><br><span class="line">        &#125; else if(response.status &#x3D;&#x3D;&#x3D; 401)&#123;</span><br><span class="line">          window.alert(&#39;请先登录&#39;)</span><br><span class="line">          window.location.href &#x3D;</span><br><span class="line">            &#96;&#x2F;sign_in?return_to&#x3D;$&#123;encodeURIComponent(window.location.pathname)&#125;&#96;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [submit, formData])</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;_onSubmit&#125;&gt;</span><br><span class="line">      &#123;fields.map(field &#x3D;&gt;</span><br><span class="line">        &lt;div key&#x3D;&#123;field.key.toString()&#125;&gt;</span><br><span class="line">          &lt;label&gt;</span><br><span class="line">            &#123;field.label&#125;</span><br><span class="line">            &#123;field.type &#x3D;&#x3D;&#x3D; &#39;textarea&#39; ?</span><br><span class="line">              &lt;textarea onChange&#x3D;&#123;(e) &#x3D;&gt; onChange(field.key, e.target.value)&#125; value&#x3D;&#123;formData[field.key].toString()&#125; &#x2F;&gt; :</span><br><span class="line">              &lt;input type&#x3D;&#123;field.type&#125; value&#x3D;&#123;formData[field.key].toString()&#125;</span><br><span class="line">                     onChange&#x3D;&#123;(e) &#x3D;&gt; onChange(field.key, e.target.value)&#125;&#x2F;&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;errors[field.key]?.length &gt; 0 &amp;&amp; &lt;div&gt;</span><br><span class="line">              &#123;errors[field.key].join(&#39;,&#39;)&#125;</span><br><span class="line">            &lt;&#x2F;div&gt;&#125;</span><br><span class="line">          &lt;&#x2F;label&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;)&#125;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;buttons&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form, setErrors: setErrors</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过安装 query-string 库实现登录成功跳转并且将 message 写成 callback</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">import &#123;GetServerSideProps, GetServerSidePropsContext, NextPage&#125; from &#39;next&#39;</span><br><span class="line">import axios, &#123; AxiosResponse &#125; from &#39;axios&#39;</span><br><span class="line">import &#123;withSession&#125; from &#39;..&#x2F;lib&#x2F;withSession&#39;</span><br><span class="line">import &#123;User&#125; from &#39;..&#x2F;src&#x2F;entity&#x2F;User&#39;</span><br><span class="line">import &#123;useForm&#125; from &#39;..&#x2F;hooks&#x2F;useForm&#39;</span><br><span class="line">import qs from &#39;query-string&#39;</span><br><span class="line"></span><br><span class="line">const SignIn: NextPage&lt;&#123;user: User&#125;&gt; &#x3D; (props) &#x3D;&gt; &#123; &#x2F;&#x2F; 利用NextPage初始化登录页面</span><br><span class="line">  const &#123;form&#125; &#x3D; useForm(&#123;</span><br><span class="line">    initFormData: &#123;</span><br><span class="line">      username: &#39;&#39;,</span><br><span class="line">      password: &#39;&#39;,</span><br><span class="line">    &#125;,</span><br><span class="line">    fields:[</span><br><span class="line">      &#123;label:&#39;用户名&#39;,type:&#39;text&#39;, key: &#39;username&#39;&#125;,</span><br><span class="line">      &#123; label:&#39;密码&#39;,type:&#39;password&#39;, key: &#39;password&#39;&#125;],</span><br><span class="line">    buttons:&lt;button type&#x3D;&quot;submit&quot;&gt;登录&lt;&#x2F;button&gt;,</span><br><span class="line">    submit: &#123;</span><br><span class="line">      request: formData &#x3D;&gt; axios.post(&#96;&#x2F;api&#x2F;v1&#x2F;sessions&#96;, formData),</span><br><span class="line">      success: () &#x3D;&gt; &#123;</span><br><span class="line">        window.alert(&#39;登录成功&#39;)</span><br><span class="line">        const query &#x3D; qs.parse(window.location.search)</span><br><span class="line">        window.location.href &#x3D; query.returnTo.toString();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &#123;</span><br><span class="line">        props.user &amp;&amp;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          当前登录用户为 &#123;props.user.username&#125;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">      &#125;</span><br><span class="line">      &lt;h1&gt;登录&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;form&#125;</span><br><span class="line">    &lt;&#x2F;&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default SignIn;</span><br><span class="line"></span><br><span class="line">export const getServerSideProps: GetServerSideProps &#x3D;</span><br><span class="line">  withSession( async (context:GetServerSidePropsContext) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; @ts-ignore</span><br><span class="line">    const user &#x3D; context.req.session.get(&#39;currentUser&#39;)</span><br><span class="line">    return &#123;</span><br><span class="line">      props: &#123;</span><br><span class="line">        user: JSON.parse(JSON.stringify(user||&#39;&#39;))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>总结博客创建逻辑</p>
</li>
<li><p>后端如果发现没登录就返回 401</p>
</li>
<li><p>前端发现 401 也提示登录，同时在登录页面 url 附上 returnTo 参数</p>
</li>
<li><p>前度登录成功之后，返回 returnTo</p>
</li>
<li><p>后端发现登录了，就可以获取 currentUser</p>
</li>
<li><p>两个页面复用代码怎么做，用户提交成功跳转列表页面</p>
</li>
</ol>
<ul>
<li>从首页拷贝代码到 posts 页面，实现展示 posts</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">import &#123;GetServerSideProps, NextPage&#125; from &#39;next&#39;;</span><br><span class="line">import &#123;getDatabaseConnection&#125; from &#39;lib&#x2F;getDatabaseConnection&#39;</span><br><span class="line">import &#123;Post&#125; from &#39;src&#x2F;entity&#x2F;Post&#39;</span><br><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type Props &#x3D; &#123;</span><br><span class="line">  posts: Post[],</span><br><span class="line">&#125;</span><br><span class="line">const PostsIndex: NextPage&lt;Props&gt; &#x3D; (props) &#x3D;&gt; &#123;</span><br><span class="line">  const &#123;posts&#125; &#x3D; props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;文章列表&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;posts.map(post &#x3D;&gt;</span><br><span class="line">        &lt;Link key&#x3D;&#123;post.id&#125; href&#x3D;&#123;&#96;&#x2F;posts&#x2F;$&#123;post.id&#125;&#96;&#125;&gt;</span><br><span class="line">          &lt;a&gt;</span><br><span class="line">            &#123;post.title&#125;</span><br><span class="line">          &lt;&#x2F;a&gt;</span><br><span class="line">        &lt;&#x2F;Link&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">export default PostsIndex;</span><br><span class="line"></span><br><span class="line">export const getServerSideProps: GetServerSideProps &#x3D; async (context) &#x3D;&gt; &#123;</span><br><span class="line">  const connection &#x3D; await getDatabaseConnection()</span><br><span class="line">  const posts &#x3D; await connection.manager.find(Post)</span><br><span class="line">  &#x2F;&#x2F; console.log(&#39;connect1&#39;)</span><br><span class="line">  return &#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">      posts : JSON.parse(JSON.stringify(posts))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>成功实现首页复用代码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import PostsIndex, &#123;getServerSideProps&#125; from &#39;.&#x2F;posts&#39;</span><br><span class="line"></span><br><span class="line">export default PostsIndex</span><br><span class="line"></span><br><span class="line">export &#123;getServerSideProps&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>分页怎么做?</p>
</li>
<li><p>设计 url</p>
<ul>
<li>/posts?page=1</li>
<li>/posts?page=N |</li>
<li>后端获取 page(查询字符串)</li>
<li>typeorm 的 page 功能</li>
<li>输出 JSON 给前端，同时告诉前端这是第几页</li>
</ul>
</li>
<li><p>微博 Facebook</p>
<ul>
<li>数据更新太快 id+offset</li>
<li>某一条记录 id 搜 20 个</li>
<li>/posts | /posts?id=</li>
<li>/posts?id=上一页的最后一个 id&amp;offset=16</li>
<li>后端获取 id 小于此 id 的数据，最多 16 条</li>
</ul>
</li>
<li><p>得到翻页计算方法，n skip (n-1)*10 take 10</p>
</li>
<li><p>完成分页最基本的样子</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">import &#123;GetServerSideProps, NextPage&#125; from &#39;next&#39;;</span><br><span class="line">import &#123;getDatabaseConnection&#125; from &#39;lib&#x2F;getDatabaseConnection&#39;</span><br><span class="line">import &#123;Post&#125; from &#39;src&#x2F;entity&#x2F;Post&#39;</span><br><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line">import qs from &#39;querystring&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type Props &#x3D; &#123;</span><br><span class="line">  posts: Post[],</span><br><span class="line">  count: number;</span><br><span class="line">  perPage: number;</span><br><span class="line">  page: number</span><br><span class="line">&#125;</span><br><span class="line">const PostsIndex: NextPage&lt;Props&gt; &#x3D; (props) &#x3D;&gt; &#123;</span><br><span class="line">  const &#123;posts&#125; &#x3D; props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;文章列表(&#123;props.count&#125;)|每页&#123;props.perPage&#125;&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;posts.map(post &#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;Link key&#x3D;&#123;post.id&#125; href&#x3D;&#123;&#96;&#x2F;posts&#x2F;$&#123;post.id&#125;&#96;&#125;&gt;</span><br><span class="line">            &lt;a&gt;</span><br><span class="line">              &#123;post.title&#125;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">          &lt;&#x2F;Link&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &lt;footer&gt;</span><br><span class="line">        共&#123;props.count&#125;篇文章,当前是第&#123;props.page&#125;页</span><br><span class="line">        &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;</span><br><span class="line">        |</span><br><span class="line">        &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;</span><br><span class="line">      &lt;&#x2F;footer&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">export default PostsIndex;</span><br><span class="line"></span><br><span class="line">export const getServerSideProps: GetServerSideProps &#x3D; async (context) &#x3D;&gt; &#123;</span><br><span class="line">  const index &#x3D; context.req.url.indexOf(&#39;?&#39;);</span><br><span class="line">  const search &#x3D; context.req.url.substr(index + 1);</span><br><span class="line">  const query &#x3D; qs.parse(search);</span><br><span class="line">  const page &#x3D; parseInt(query.page.toString()) || 1;</span><br><span class="line"></span><br><span class="line">  const connection &#x3D; await getDatabaseConnection()</span><br><span class="line">  const perPage &#x3D; 3;</span><br><span class="line">  const [posts, count] &#x3D; await connection.manager.findAndCount(Post,</span><br><span class="line">    &#123;skip:(page-1)*perPage, take:perPage&#125;);</span><br><span class="line"></span><br><span class="line">  console.log(&#39;query&#39;, query);</span><br><span class="line">  return &#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">      posts : JSON.parse(JSON.stringify(posts)),</span><br><span class="line">      count: count,</span><br><span class="line">      perPage,</span><br><span class="line">      page</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p>上一步做了什么</p>
<ol>
<li>获取查询参数 pate = N</li>
<li>计算:(N-1)*perPage 和 take: perPage</li>
<li>把数据,count,perPage,page 传给页面(SSR)</li>
<li>前端显示数据，count,page</li>
</ol>
</li>
<li><p>初步完成分页</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">import &#123;GetServerSideProps, NextPage&#125; from &#39;next&#39;;</span><br><span class="line">import &#123;getDatabaseConnection&#125; from &#39;lib&#x2F;getDatabaseConnection&#39;</span><br><span class="line">import &#123;Post&#125; from &#39;src&#x2F;entity&#x2F;Post&#39;</span><br><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line">import qs from &#39;querystring&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">type Props &#x3D; &#123;</span><br><span class="line">  posts: Post[],</span><br><span class="line">  count: number;</span><br><span class="line">  perPage: number;</span><br><span class="line">  page: number;</span><br><span class="line">  totalPage: number;</span><br><span class="line">&#125;</span><br><span class="line">const PostsIndex: NextPage&lt;Props&gt; &#x3D; (props) &#x3D;&gt; &#123;</span><br><span class="line">  const &#123;posts&#125; &#x3D; props;</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;文章列表(&#123;props.count&#125;)|每页&#123;props.perPage&#125;&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;posts.map(post &#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;Link key&#x3D;&#123;post.id&#125; href&#x3D;&#123;&#96;&#x2F;posts&#x2F;$&#123;post.id&#125;&#96;&#125;&gt;</span><br><span class="line">            &lt;a&gt;</span><br><span class="line">              &#123;post.title&#125;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">          &lt;&#x2F;Link&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &lt;footer&gt;</span><br><span class="line">        共&#123;props.count&#125;篇文章,当前是第&#123;props.page&#125; &#x2F; &#123;props.totalPage&#125;页</span><br><span class="line">        &#123;props.page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line"></span><br><span class="line">        &#123;props.page &lt; props.totalPage &amp;&amp; &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line"></span><br><span class="line">      &lt;&#x2F;footer&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">export default PostsIndex;</span><br><span class="line"></span><br><span class="line">export const getServerSideProps: GetServerSideProps &#x3D; async (context) &#x3D;&gt; &#123;</span><br><span class="line">  const index &#x3D; context.req.url.indexOf(&#39;?&#39;);</span><br><span class="line">  const search &#x3D; context.req.url.substr(index + 1);</span><br><span class="line">  const query &#x3D; qs.parse(search);</span><br><span class="line">  const page &#x3D; parseInt(query.page.toString()) || 1;</span><br><span class="line">  const connection &#x3D; await getDatabaseConnection()</span><br><span class="line">  const perPage &#x3D; 3;</span><br><span class="line">  const [posts, count] &#x3D; await connection.manager.findAndCount(Post,</span><br><span class="line">    &#123;skip:(page-1)*perPage, take:perPage&#125;);</span><br><span class="line"></span><br><span class="line">  console.log(&#39;query&#39;, query);</span><br><span class="line">  return &#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">      posts : JSON.parse(JSON.stringify(posts)),</span><br><span class="line">      count: count,</span><br><span class="line">      perPage,</span><br><span class="line">      page,</span><br><span class="line">      totalPage:Math.ceil(count &#x2F; perPage)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>封装 pager 组件</li>
</ol>
<ul>
<li>需求 &lt;1 …3 4 5 6 7 8 9 10&gt; 第 6/10 页</li>
</ul>
<ol start="10">
<li>搭建并且使用 pager</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; usePager</span><br><span class="line">export const usePager &#x3D; ()&#x3D;&gt;&#123;</span><br><span class="line">  const pager &#x3D; (</span><br><span class="line">    &lt;div&gt;pager&lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;pager&#125;;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; index.tsx</span><br><span class="line">const PostsIndex: NextPage&lt;Props&gt; &#x3D; (props) &#x3D;&gt; &#123;</span><br><span class="line">  const &#123;posts&#125; &#x3D; props;</span><br><span class="line">  const &#123;pager&#125; &#x3D; usePager()</span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;文章列表(&#123;props.count&#125;)|每页&#123;props.perPage&#125;&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;posts.map(post &#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;Link key&#x3D;&#123;post.id&#125; href&#x3D;&#123;&#96;&#x2F;posts&#x2F;$&#123;post.id&#125;&#96;&#125;&gt;</span><br><span class="line">            &lt;a&gt;</span><br><span class="line">              &#123;post.title&#125;</span><br><span class="line">            &lt;&#x2F;a&gt;</span><br><span class="line">          &lt;&#x2F;Link&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &lt;footer&gt;</span><br><span class="line">        &#123;pager&#125;</span><br><span class="line">        共&#123;props.count&#125;篇文章,当前是第&#123;props.page&#125; &#x2F; &#123;props.totalPage&#125;页</span><br><span class="line">        &#123;props.page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line"></span><br><span class="line">        &#123;props.page &lt; props.totalPage &amp;&amp; &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;props.page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line"></span><br><span class="line">      &lt;&#x2F;footer&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line">export default PostsIndex;</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>把之前的代码放到 usePager</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line"></span><br><span class="line">type Options &#x3D; &#123;</span><br><span class="line">  count: number;</span><br><span class="line">  page: number;</span><br><span class="line">  totalPage: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const usePager &#x3D; (options: Options)&#x3D;&gt;&#123;</span><br><span class="line">  const &#123;count, page, totalPage&#125; &#x3D; options</span><br><span class="line">  const pager &#x3D; (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      共&#123;count&#125;篇文章,当前是第&#123;page&#125; &#x2F; &#123;totalPage&#125;页</span><br><span class="line">      &#123;page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line">      &#123;page &lt; totalPage &amp;&amp; &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;pager&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>usePager 功能基本完成</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line">import &#123;number&#125; from &#39;prop-types&#39;</span><br><span class="line">import _ from &#39;lodash&#39;</span><br><span class="line"></span><br><span class="line">type Options &#x3D; &#123;</span><br><span class="line">  page: number;</span><br><span class="line">  totalPage: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const usePager &#x3D; (options: Options)&#x3D;&gt;&#123;</span><br><span class="line">  const &#123; page, totalPage&#125; &#x3D; options</span><br><span class="line">  const numbers &#x3D; [];</span><br><span class="line">  numbers.push(1);</span><br><span class="line">  for (let i &#x3D; page - 3; i&lt;&#x3D; page + 3; i++)&#123;</span><br><span class="line">    numbers.push(i);</span><br><span class="line">  &#125;</span><br><span class="line">  numbers.push(totalPage);</span><br><span class="line">  &#x2F;&#x2F; x&#x3D; [1,2,3,4,5,7]</span><br><span class="line">  &#x2F;&#x2F; y &#x3D; [1,2,3,4,5,-1,7]</span><br><span class="line">  const pageNumbers &#x3D; _.uniq(numbers).sort().filter(n&#x3D;&gt; n&gt;&#x3D;1 &amp;&amp; n &lt; totalPage).reduce((result,n)&#x3D;&gt; n - (result[result.length-1]|| 0) &#x3D;&#x3D;&#x3D; 1?</span><br><span class="line">    result.concat(n): result.concat(-1,n),[]);</span><br><span class="line"></span><br><span class="line">  const pager &#x3D; (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line">      &#123;pageNumbers.map(n &#x3D;&gt; n &#x3D;&#x3D;&#x3D; -1 ?</span><br><span class="line">        &lt;span&gt;...&lt;&#x2F;span&gt;:</span><br><span class="line">        &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;n&#125;&#96;&#125;&gt;</span><br><span class="line">          &lt;a&gt;&#123;n&#125;&lt;&#x2F;a&gt;</span><br><span class="line">        &lt;&#x2F;Link&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &#123;page &lt; totalPage &amp;&amp; &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        第&#123;page&#125; &#x2F; &#123;totalPage&#125;页</span><br><span class="line">      &lt;&#x2F;span&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;pager&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>给 pager 增加 css</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line">import &#123;number&#125; from &#39;prop-types&#39;</span><br><span class="line">import _ from &#39;lodash&#39;</span><br><span class="line"></span><br><span class="line">type Options &#x3D; &#123;</span><br><span class="line">  page: number;</span><br><span class="line">  totalPage: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const usePager &#x3D; (options: Options)&#x3D;&gt;&#123;</span><br><span class="line">  const &#123; page, totalPage&#125; &#x3D; options</span><br><span class="line">  const numbers &#x3D; [];</span><br><span class="line">  numbers.push(1);</span><br><span class="line">  for (let i &#x3D; page - 3; i&lt;&#x3D; page + 3; i++)&#123;</span><br><span class="line">    numbers.push(i);</span><br><span class="line">  &#125;</span><br><span class="line">  numbers.push(totalPage);</span><br><span class="line">  &#x2F;&#x2F; x&#x3D; [1,2,3,4,5,7]</span><br><span class="line">  &#x2F;&#x2F; y &#x3D; [1,2,3,4,5,-1,7]</span><br><span class="line">  const pageNumbers &#x3D; _.uniq(numbers).sort().filter(n&#x3D;&gt; n&gt;&#x3D;1 &amp;&amp; n &lt; totalPage).reduce((result,n)&#x3D;&gt; n - (result[result.length-1]|| 0) &#x3D;&#x3D;&#x3D; 1?</span><br><span class="line">    result.concat(n): result.concat(-1,n),[]);</span><br><span class="line"></span><br><span class="line">  const pager &#x3D; (</span><br><span class="line">    &lt;div className&#x3D;&quot;wrapper&quot;&gt;</span><br><span class="line">      &#123;page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page-1&#125;&#96;&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line">      &#123;pageNumbers.map(n &#x3D;&gt; n &#x3D;&#x3D;&#x3D; -1 ?</span><br><span class="line">        &lt;span&gt;...&lt;&#x2F;span&gt;:</span><br><span class="line">        &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;n&#125;&#96;&#125;&gt;</span><br><span class="line">          &lt;a&gt;&#123;n&#125;&lt;&#x2F;a&gt;</span><br><span class="line">        &lt;&#x2F;Link&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &#123;page &lt; totalPage &amp;&amp; &lt;Link href&#x3D;&#123;&#96;?page&#x3D;$&#123;page+1&#125;&#96;&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        第&#123;page&#125; &#x2F; &#123;totalPage&#125;页</span><br><span class="line">      &lt;&#x2F;span&gt;</span><br><span class="line">      &lt;style jsx&gt;&#123;&#96;</span><br><span class="line">        .wrapper &#123;</span><br><span class="line">          margin: 0 -8px;</span><br><span class="line">        &#125;</span><br><span class="line">        .wrapper &gt; a, .wrapper &gt; span &#123;</span><br><span class="line">          margin: 0 8px;</span><br><span class="line">        &#125;</span><br><span class="line">      &#96;&#125;&lt;&#x2F;style&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;pager&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>通过 urlMaker 解耦,抽离 userpager 自定义 hook</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">import Link from &#39;next&#x2F;link&#39;</span><br><span class="line">import &#123;number&#125; from &#39;prop-types&#39;</span><br><span class="line">import _ from &#39;lodash&#39;</span><br><span class="line"></span><br><span class="line">type Options &#x3D; &#123;</span><br><span class="line">  page: number;</span><br><span class="line">  totalPage: number;</span><br><span class="line">  urlMaker?: (n: number) &#x3D;&gt; string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const defaultUrlMaker &#x3D; (n:number) &#x3D;&gt; &#96;?page&#x3D;$&#123;n&#125;&#96;</span><br><span class="line"></span><br><span class="line">export const usePager &#x3D; (options: Options)&#x3D;&gt;&#123;</span><br><span class="line">  const &#123; page, totalPage, urlMaker:_urlMaker&#125; &#x3D; options</span><br><span class="line">  const urlMaker &#x3D; _urlMaker || defaultUrlMaker</span><br><span class="line">  const numbers &#x3D; [];</span><br><span class="line">  numbers.push(1);</span><br><span class="line">  for (let i &#x3D; page - 3; i&lt;&#x3D; page + 3; i++)&#123;</span><br><span class="line">    numbers.push(i);</span><br><span class="line">  &#125;</span><br><span class="line">  numbers.push(totalPage);</span><br><span class="line">  &#x2F;&#x2F; x&#x3D; [1,2,3,4,5,7]</span><br><span class="line">  &#x2F;&#x2F; y &#x3D; [1,2,3,4,5,-1,7]</span><br><span class="line">  const pageNumbers &#x3D; _.uniq(numbers).sort().filter(n&#x3D;&gt; n&gt;&#x3D;1 &amp;&amp; n &lt; totalPage).reduce((result,n)&#x3D;&gt; n - (result[result.length-1]|| 0) &#x3D;&#x3D;&#x3D; 1?</span><br><span class="line">    result.concat(n): result.concat(-1,n),[]);</span><br><span class="line"></span><br><span class="line">  const pager &#x3D; (</span><br><span class="line">    &lt;div className&#x3D;&quot;wrapper&quot;&gt;</span><br><span class="line">      &#123;page !&#x3D;&#x3D; 1 &amp;&amp;  &lt;Link href&#x3D;&#123;urlMaker(page-1)&#125;&gt;&lt;a&gt;上一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt; &#125;</span><br><span class="line">      &#123;pageNumbers.map(n &#x3D;&gt; n &#x3D;&#x3D;&#x3D; -1 ?</span><br><span class="line">        &lt;span&gt;...&lt;&#x2F;span&gt;:</span><br><span class="line">        &lt;Link href&#x3D;&#123;urlMaker(n)&#125;&gt;</span><br><span class="line">          &lt;a&gt;&#123;n&#125;&lt;&#x2F;a&gt;</span><br><span class="line">        &lt;&#x2F;Link&gt;</span><br><span class="line">      )&#125;</span><br><span class="line">      &#123;page &lt; totalPage &amp;&amp; &lt;Link href&#x3D;&#123;urlMaker(page+1)&#125;&gt;&lt;a&gt;下一页&lt;&#x2F;a&gt;&lt;&#x2F;Link&gt;&#125;</span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        第&#123;page&#125; &#x2F; &#123;totalPage&#125;页</span><br><span class="line">      &lt;&#x2F;span&gt;</span><br><span class="line">      &lt;style jsx&gt;&#123;&#96;</span><br><span class="line">        .wrapper &#123;</span><br><span class="line">          margin: 0 -8px;</span><br><span class="line">        &#125;</span><br><span class="line">        .wrapper &gt; a, .wrapper &gt; span &#123;</span><br><span class="line">          margin: 0 8px;</span><br><span class="line">        &#125;</span><br><span class="line">      &#96;&#125;&lt;&#x2F;style&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;pager&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>修复一个小 bug,page 为空</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const page &#x3D; parseInt(query.page?.toString()) || 1;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9023%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B05%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9023%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B05%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2/" class="post-title-link" itemprop="url">高级前端养成23博客系统之05创建博客</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-08-11 20:06:11 / Modified: 20:07:18" itemprop="dateCreated datePublished" datetime="2020-08-11T20:06:11+08:00">2020-08-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93-%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">数据库 博客系统</span></a>
                </span>
            </span>

          
            <span id="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9023%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B05%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成23博客系统之05创建博客" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9023%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B05%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/11/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9023%E5%8D%9A%E5%AE%A2%E7%B3%BB%E7%BB%9F%E4%B9%8B05%E5%88%9B%E5%BB%BA%E5%8D%9A%E5%AE%A2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ol>
<li>如何在代码中隐藏代码或者密钥</li>
</ol>
<ul>
<li>需求 withSession.tsx 中的 password</li>
<li>第一种方式:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; bash</span><br><span class="line">export SECRET&#x3D;8963956d-3de2-45e8-a608-ff08313827a3</span><br><span class="line">&#x2F;&#x2F; 代码里</span><br><span class="line">password: process.env.SECRET,</span><br></pre></td></tr></table></figure>
<ul>
<li>在开发的时候执行一遍，在部署的机子执行一遍，那么密码就自己知道</li>
</ul>
</li>
<li>第二种方式:next.js 内置对环境变量支持,<a href="https://nextjs.org/docs/basic-features/environment-variables" target="_blank" rel="noopener">文档</a><ul>
<li>创建.env.local 设置环境变量<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET&#x3D;8963956d-3de2-45e8-a608-ff08313827a3</span><br></pre></td></tr></table></figure></li>
<li>马上在.gitignore 中加入.env.local</li>
</ul>
</li>
</ul>
<ol start="2">
<li>消除一处 @ts-ignore</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; withSession.tsx</span><br><span class="line">export function withSession(handler:NextApiHandler | GetServerSideProps) &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; sign_in.tsx</span><br><span class="line">export const getServerSideProps: GetServerSideProps &#x3D;</span><br><span class="line">  withSession( async (context:GetServerSidePropsContext) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; @ts-ignore</span><br><span class="line">    const user &#x3D; context.req.session.get(&#39;currentUser&#39;)</span><br><span class="line">    return &#123;</span><br><span class="line">      props: &#123;</span><br><span class="line">        user: JSON.parse(JSON.stringify(user))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>博客的创建</p>
</li>
<li><p>封装 form 组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import &#123;ChangeEventHandler, FormEventHandler, ReactChild&#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">type Props &#x3D; &#123;</span><br><span class="line">  onSubmit: FormEventHandler;</span><br><span class="line">  fields: &#123;</span><br><span class="line">    label: string,</span><br><span class="line">    type: &#39;text&#39;|&#39;password&#39;|&#39;textarea&#39;,</span><br><span class="line">    value: string | number,</span><br><span class="line">    onChange: ChangeEventHandler&lt;HTMLInputElement | HTMLTextAreaElement&gt;,</span><br><span class="line">    errors: string[]</span><br><span class="line">  &#125;[];</span><br><span class="line">  buttons: ReactChild</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export const Form: React.FC&lt;Props&gt; &#x3D; (props) &#x3D;&gt;&#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;props.onSubmit&#125;&gt;</span><br><span class="line">      &#123;props.fields.map(field&#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;label&gt;</span><br><span class="line">            &#123;field.label&#125;</span><br><span class="line">            &#123;field.type &#x3D;&#x3D;&#x3D; &#39;textarea&#39; ?</span><br><span class="line">              &lt;textarea onChange&#x3D;&#123;field.onChange&#125;&gt;&#123;field.value&#125;&lt;&#x2F;textarea&gt;:</span><br><span class="line">              &lt;input type&#x3D;&#123;field.type&#125; value&#x3D;&#123;field.value&#125;</span><br><span class="line">              onChange &#x3D; &#123;field.onChange&#125;&#x2F;&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;field.errors?.length &gt; 0 &amp;&amp; &lt;div&gt;</span><br><span class="line">              &#123;field.errors.join(&#39;,&#39;)&#125;</span><br><span class="line">            &lt;&#x2F;div&gt;&#125;</span><br><span class="line">          &lt;&#x2F;label&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;)&#125;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &#123;props.buttons&#125;</span><br><span class="line">        &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建 posts/new.tsx</p>
</li>
</ol>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">import &#123;NextPage&#125; from &#39;next&#39;</span><br><span class="line">import &#123;Form&#125; from &#39;..&#x2F;..&#x2F;components&#x2F;form&#39;</span><br><span class="line">import &#123;useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line">import axios, &#123;AxiosResponse&#125; from &#39;axios&#39;</span><br><span class="line"></span><br><span class="line">const PostsNew: NextPage &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(&#123;</span><br><span class="line">    title: &#39;&#39;,</span><br><span class="line">    content:[]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const [errors, setErrors] &#x3D; useState(&#123;</span><br><span class="line">    title:[], content:[]</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key, value)&#x3D;&gt;&#123;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,[formData])</span><br><span class="line"></span><br><span class="line">  const onSubmit &#x3D; useCallback((e)&#x3D;&gt;&#123;</span><br><span class="line">    e.preventDefault()</span><br><span class="line">    axios.post(&#96;&#x2F;api&#x2F;v1&#x2F;posts&#96;, formData)</span><br><span class="line">      .then(()&#x3D;&gt;&#123;</span><br><span class="line">        alert(&#39;提交成功!&#39;)</span><br><span class="line">      &#125;,(error)&#x3D;&gt;&#123;</span><br><span class="line">        if(error.response)&#123;</span><br><span class="line">          const response: AxiosResponse &#x3D; error.response;</span><br><span class="line">          &#x2F;&#x2F; if(response)</span><br><span class="line">          if(response.status &#x3D;&#x3D;&#x3D; 422)&#123;</span><br><span class="line">            setErrors(response.data);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;,[formData]) &#x2F;&#x2F; []不加参数参数，表示只在页面第一次创建渲染创建onSubmit函数,其它时候ui怎么变,onSubmit不变</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Form fields&#x3D;&#123;[</span><br><span class="line">        &#123;label:&#39;标题&#39;,type:&#39;text&#39;, value: formData.title,</span><br><span class="line">          onChange: e&#x3D;&gt;onChange(&#39;username&#39;, e.target.value)</span><br><span class="line">          , errors: errors.title &#125;,</span><br><span class="line">        &#123;label:&#39;内容&#39;,type:&#39;textarea&#39;, value: formData.title,</span><br><span class="line">          onChange: e&#x3D;&gt;onChange(&#39;username&#39;, e.target.value)</span><br><span class="line">          , errors: errors.title &#125;,</span><br><span class="line">      ]</span><br><span class="line">      &#125; onSubmit&#x3D;&#123;onSubmit&#125; buttons&#x3D;&#123;&lt;&gt;</span><br><span class="line">        &lt;button type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;</span><br><span class="line">      &lt;&#x2F;&gt;&#125; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default PostsNew;</span><br></pre></td></tr></table></figure></code></pre>
<ol start="4">
<li>进一步封装代码</li>
</ol>
<ul>
<li><p>先设计好如何使用封装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">const onSubmit &#x3D; (formData) &#x3D;&gt; &#123;</span><br><span class="line">  axios.post().then(()&#x3D;&gt;&#123;</span><br><span class="line">    window.alert()</span><br><span class="line">  &#125;,(e)&#x3D;&gt;&#123;</span><br><span class="line">    setErrors(e.response.data)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;;</span><br><span class="line">const &#123;form,setErrors&#125; &#x3D; useForm(initFormData,initErrors,fields,onSubmit);</span><br><span class="line"></span><br><span class="line">return(</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &#123;form&#125;</span><br><span class="line">  &lt;&#x2F;div&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>T 占位符</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export function useForm&lt;T&gt;(initFormData:T)&#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form&gt;1&lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>受控 input 和非受控 input，自己操心数据变更 props,数据由 props 控制</p>
<ul>
<li>受控 input</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;input value&#x3D;xxx onChange&#x3D;&#123;e&#x3D;&gt; xxx&#x3D;e.target.value&#125; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>非受控 input，组件搞定数据变更,value 由组件内部的 state 变化</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;input defaultValue&#x3D;xxx&#x2F; ref&#x3D;&#123;inputRef&#125;&gt;</span><br><span class="line">&#x2F;&#x2F; 通过ref去获得值,inputRef.current.value</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://zh-hans.reactjs.org/docs/uncontrolled-components.html" target="_blank" rel="noopener">相关文档</a></li>
</ul>
</li>
<li><p>获得 error 的初始值 e</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">import &#123;useState&#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(initFormData:T)&#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  &#x2F;&#x2F; initFormData &#x3D; &#123;username:&#39;&#39;, password:&#39;&#39;&#125;</span><br><span class="line">  &#x2F;&#x2F; initErrors &#x3D; &#123;username: [], password: []&#125;</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: string]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: keyof T]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; [key in keyof T] &#x3D; k in (&#39;title&#39;|&#39;password&#39;)</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125;; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key))&#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form&gt;1&lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>完成 onchange 事件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">const onChange &#x3D; useCallback((key: keyof T, value: any)&#x3D;&gt;&#123;</span><br><span class="line">   &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">   setFormData(&#123;</span><br><span class="line">     ...formData,</span><br><span class="line">     [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,[formData])</span><br></pre></td></tr></table></figure>

<ul>
<li>完成外部传进来的 onSubmit 事件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import &#123;useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(initFormData: T, onSubmit: (fd: T) &#x3D;&gt; void) &#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line"></span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  &#x2F;&#x2F; initFormData &#x3D; &#123;username:&#39;&#39;, password:&#39;&#39;&#125;</span><br><span class="line">  &#x2F;&#x2F; initErrors &#x3D; &#123;username: [], password: []&#125;</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: string]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: keyof T]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; [key in keyof T] &#x3D; k in (&#39;title&#39;|&#39;password&#39;)</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key)) &#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key: keyof T, value: any) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [formData])</span><br><span class="line"></span><br><span class="line">  const _onSubmit &#x3D; useCallback((e) &#x3D;&gt; &#123;</span><br><span class="line">    e.preventDefault() &#x2F;&#x2F; 调用外面submit</span><br><span class="line">    onSubmit(formData)</span><br><span class="line">  &#125;, [onSubmit, formData])</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form&gt;1&lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>继续为 useForm 增加 fields,buttons</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">import &#123;ChangeEventHandler, ReactChild, useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">type Field &#x3D; &#123;</span><br><span class="line">  label: string,</span><br><span class="line">  type: &#39;text&#39;|&#39;password&#39;|&#39;textarea&#39;,</span><br><span class="line">  value: string | number,</span><br><span class="line">  onChange: ChangeEventHandler&lt;HTMLInputElement | HTMLTextAreaElement&gt;,</span><br><span class="line">  errors: string[]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(initFormData: T, fields: Field[],  buttons: ReactChild, onSubmit: (fd: T) &#x3D;&gt; void) &#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  &#x2F;&#x2F; initFormData &#x3D; &#123;username:&#39;&#39;, password:&#39;&#39;&#125;</span><br><span class="line">  &#x2F;&#x2F; initErrors &#x3D; &#123;username: [], password: []&#125;</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: string]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; const e: &#123; [k: keyof T]: string[] &#125; &#x3D; &#123;&#125;;</span><br><span class="line">    &#x2F;&#x2F; [key in keyof T] &#x3D; k in (&#39;title&#39;|&#39;password&#39;)</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key)) &#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key: keyof T, value: any) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [formData])</span><br><span class="line"></span><br><span class="line">  const _onSubmit &#x3D; useCallback((e) &#x3D;&gt; &#123;</span><br><span class="line">    e.preventDefault() &#x2F;&#x2F; 调用外面submit</span><br><span class="line">    onSubmit(formData)</span><br><span class="line">  &#125;, [onSubmit, formData])</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;_onSubmit&#125;&gt;</span><br><span class="line">      &#123;fields.map(field&#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;label&gt;</span><br><span class="line">            &#123;field.label&#125;</span><br><span class="line">            &#123;field.type &#x3D;&#x3D;&#x3D; &#39;textarea&#39; ?</span><br><span class="line">              &lt;textarea onChange&#x3D;&#123;field.onChange&#125;&gt;&#123;field.value&#125;&lt;&#x2F;textarea&gt;:</span><br><span class="line">              &lt;input type&#x3D;&#123;field.type&#125; value&#x3D;&#123;field.value&#125;</span><br><span class="line">                     onChange &#x3D; &#123;field.onChange&#125;&#x2F;&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;field.errors?.length &gt; 0 &amp;&amp; &lt;div&gt;</span><br><span class="line">              &#123;field.errors.join(&#39;,&#39;)&#125;</span><br><span class="line">            &lt;&#x2F;div&gt;&#125;</span><br><span class="line">          &lt;&#x2F;label&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;)&#125;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;buttons&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>useForm 造完</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">import &#123;ChangeEventHandler, ReactChild, useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line"></span><br><span class="line">type Field&lt;T&gt; &#x3D; &#123;</span><br><span class="line">  label: string,</span><br><span class="line">  type: &#39;text&#39;|&#39;password&#39;|&#39;textarea&#39;,</span><br><span class="line">  key: keyof T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(initFormData: T, fields: Field&lt;T&gt;[],  buttons: ReactChild, onSubmit: (fd: T) &#x3D;&gt; void) &#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key)) &#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key: keyof T, value: any) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [formData])</span><br><span class="line"></span><br><span class="line">  const _onSubmit &#x3D; useCallback((e) &#x3D;&gt; &#123;</span><br><span class="line">    e.preventDefault() &#x2F;&#x2F; 调用外面submit</span><br><span class="line">    onSubmit(formData)</span><br><span class="line">  &#125;, [onSubmit, formData])</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;_onSubmit&#125;&gt;</span><br><span class="line">      &#123;fields.map(field&#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;label&gt;</span><br><span class="line">            &#123;field.label&#125;</span><br><span class="line">            &#123;field.type &#x3D;&#x3D;&#x3D; &#39;textarea&#39; ?</span><br><span class="line">              &lt;textarea onChange&#x3D;&#123;(e)&#x3D;&gt; onChange(field.key, e.target.value)&#125;&gt;&#123;formData[field.key]&#125;&lt;&#x2F;textarea&gt;:</span><br><span class="line">              &lt;input type&#x3D;&#123;field.type&#125; value&#x3D;&#123;formData[field.key].toString()&#125;</span><br><span class="line">                     onChange &#x3D; &#123;(e)&#x3D;&gt; onChange(field.key, e.target.value)&#125;&#x2F;&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;errors[field.key]?.length &gt; 0 &amp;&amp; &lt;div&gt;</span><br><span class="line">              &#123;errors[field.key].join(&#39;,&#39;)&#125;</span><br><span class="line">            &lt;&#x2F;div&gt;&#125;</span><br><span class="line">          &lt;&#x2F;label&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;)&#125;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;buttons&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>成功在 new.tsx 中使用封装的 useForm</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">import &#123;NextPage&#125; from &#39;next&#39;</span><br><span class="line">import axios, &#123;AxiosResponse&#125; from &#39;axios&#39;</span><br><span class="line">import &#123;useForm&#125; from &#39;..&#x2F;..&#x2F;hooks&#x2F;useForm&#39;</span><br><span class="line"></span><br><span class="line">const PostsNew: NextPage &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line"></span><br><span class="line">  const onSubmit &#x3D; (formData: typeof initFormData)&#x3D;&gt;&#123;</span><br><span class="line">    axios.post(&#96;&#x2F;api&#x2F;v1&#x2F;posts&#96;, formData)</span><br><span class="line">      .then(()&#x3D;&gt;&#123;</span><br><span class="line">        alert(&#39;提交成功!&#39;)</span><br><span class="line">      &#125;,(error)&#x3D;&gt;&#123;</span><br><span class="line">        if(error.response)&#123;</span><br><span class="line">          const response: AxiosResponse &#x3D; error.response;</span><br><span class="line">          &#x2F;&#x2F; if(response)</span><br><span class="line">          if(response.status &#x3D;&#x3D;&#x3D; 422)&#123;</span><br><span class="line">            setErrors(response.data);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;&#x2F;&#x2F; []不加参数参数，表示只在页面第一次创建渲染创建onSubmit函数,其它时候ui怎么变,onSubmit不变</span><br><span class="line"></span><br><span class="line">  const initFormData &#x3D;  &#123;title: &#39;&#39;, content: &#39;&#39;&#125;</span><br><span class="line"></span><br><span class="line">  const &#123;form, setErrors&#125; &#x3D; useForm(</span><br><span class="line">    initFormData,</span><br><span class="line">    [</span><br><span class="line">          &#123;label:&#39;标题&#39;,type:&#39;text&#39;, key: &#39;title&#39;&#125;,</span><br><span class="line">          &#123;label:&#39;内容&#39;,type:&#39;textarea&#39;, key:&#39;content&#39;&#125;,</span><br><span class="line">        ],</span><br><span class="line">        &lt;button type&#x3D;&quot;submit&quot;&gt;提交&lt;&#x2F;button&gt;,</span><br><span class="line">    onSubmit</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  return(</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &#123;form&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default PostsNew;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>继续优化封装 useform</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">import &#123; ReactChild, useCallback, useState&#125; from &#39;react&#39;</span><br><span class="line">import &#123;AxiosResponse&#125; from &#39;axios&#39;</span><br><span class="line"></span><br><span class="line">type Field&lt;T&gt; &#x3D; &#123;</span><br><span class="line">  label: string,</span><br><span class="line">  type: &#39;text&#39; | &#39;password&#39; | &#39;textarea&#39;,</span><br><span class="line">  key: keyof T,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type useFormOptions&lt;T&gt; &#x3D; &#123;</span><br><span class="line">  initFormData: T;</span><br><span class="line">  fields: Field&lt;T&gt;[];</span><br><span class="line">  buttons: ReactChild;</span><br><span class="line">  submit: &#123;</span><br><span class="line">    request: (formData:T)&#x3D;&gt; Promise&lt;AxiosResponse&lt;T&gt;&gt;;</span><br><span class="line">    message: string;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function useForm&lt;T&gt;(options: useFormOptions&lt;T&gt;) &#123; &#x2F;&#x2F; 通过参数反推T,useForm里面有个T,T的类型就是initFormData的类型</span><br><span class="line">  const &#123;initFormData, fields, buttons, submit&#125; &#x3D; options</span><br><span class="line">  &#x2F;&#x2F; 非受控</span><br><span class="line">  const [formData, setFormData] &#x3D; useState(initFormData)</span><br><span class="line">  const [errors, setErrors] &#x3D; useState(() &#x3D;&gt; &#123;</span><br><span class="line">    const e: &#123; [key in keyof T]?: string[] &#125; &#x3D; &#123;&#125; &#x2F;&#x2F; 死记硬背, key的下标全部都是T的下标</span><br><span class="line">    for (let key in initFormData) &#123;</span><br><span class="line">      if (initFormData.hasOwnProperty(key)) &#123;</span><br><span class="line">        e[key] &#x3D; []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return e &#x2F;&#x2F; 只做初始值</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  const onChange &#x3D; useCallback((key: keyof T, value: any) &#x3D;&gt; &#123;</span><br><span class="line">    &#x2F;&#x2F; 看到keyof 就脑补成, &#39;username&#39;|&#39;password&#39;</span><br><span class="line">    setFormData(&#123;</span><br><span class="line">      ...formData,</span><br><span class="line">      [key]: value &#x2F;&#x2F; [key]如果不加[]，就是&quot;key&quot;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [formData])</span><br><span class="line"></span><br><span class="line">  const _onSubmit &#x3D; useCallback((e) &#x3D;&gt; &#123;</span><br><span class="line">    e.preventDefault() &#x2F;&#x2F; 调用外面submit</span><br><span class="line">    submit.request(formData).then(()&#x3D;&gt;&#123;</span><br><span class="line">      window.alert(submit.message)</span><br><span class="line">    &#125;,(error)&#x3D;&gt;&#123;</span><br><span class="line">      if (error.response) &#123;</span><br><span class="line">        const response: AxiosResponse &#x3D; error.response</span><br><span class="line">        if (response.status &#x3D;&#x3D;&#x3D; 422) &#123;</span><br><span class="line">          setErrors(response.data)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;, [submit, formData])</span><br><span class="line"></span><br><span class="line">  const form &#x3D; (</span><br><span class="line">    &lt;form onSubmit&#x3D;&#123;_onSubmit&#125;&gt;</span><br><span class="line">      &#123;fields.map(field &#x3D;&gt;</span><br><span class="line">        &lt;div&gt;</span><br><span class="line">          &lt;label&gt;</span><br><span class="line">            &#123;field.label&#125;</span><br><span class="line">            &#123;field.type &#x3D;&#x3D;&#x3D; &#39;textarea&#39; ?</span><br><span class="line">              &lt;textarea onChange&#x3D;&#123;(e) &#x3D;&gt; onChange(field.key, e.target.value)&#125;&gt;&#123;formData[field.key]&#125;&lt;&#x2F;textarea&gt; :</span><br><span class="line">              &lt;input type&#x3D;&#123;field.type&#125; value&#x3D;&#123;formData[field.key].toString()&#125;</span><br><span class="line">                     onChange&#x3D;&#123;(e) &#x3D;&gt; onChange(field.key, e.target.value)&#125;&#x2F;&gt;</span><br><span class="line">            &#125;</span><br><span class="line">            &#123;errors[field.key]?.length &gt; 0 &amp;&amp; &lt;div&gt;</span><br><span class="line">              &#123;errors[field.key].join(&#39;,&#39;)&#125;</span><br><span class="line">            &lt;&#x2F;div&gt;&#125;</span><br><span class="line">          &lt;&#x2F;label&gt;</span><br><span class="line">        &lt;&#x2F;div&gt;)&#125;</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &#123;buttons&#125;</span><br><span class="line">      &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  )</span><br><span class="line">  return &#123;</span><br><span class="line">    form: form, setErrors: setErrors</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>使用最终优化的 useform,以 sign_up 为例</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import &#123;NextPage&#125; from &#39;next&#39;</span><br><span class="line">import &#123; useState, useCallback &#125; from &#39;react&#39;;</span><br><span class="line">import axios, &#123; AxiosResponse &#125; from &#39;axios&#39;</span><br><span class="line">import &#123; useForm &#125; from &#39;hooks&#x2F;useForm&#39;;</span><br><span class="line"></span><br><span class="line">const SignUp: NextPage &#x3D; () &#x3D;&gt; &#123; &#x2F;&#x2F; 利用NextPage初始化注册页面</span><br><span class="line">  const &#123;form&#125; &#x3D; useForm(&#123;</span><br><span class="line">    initFormData:&#123;</span><br><span class="line">      username: &#39;&#39;,</span><br><span class="line">      password: &#39;&#39;,</span><br><span class="line">      passwordConfirmation: &#39;&#39;</span><br><span class="line">    &#125;,</span><br><span class="line">    fields:[</span><br><span class="line">      &#123;</span><br><span class="line">        label:&#39;用户名&#39;,type:&#39;text&#39;, key: &#39;username&#39;,</span><br><span class="line">       &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: &#39;密码&#39;, type: &#39;password&#39;, key: &#39;password&#39;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label:&#39;确认密码&#39;,type:&#39;password&#39;, key: &#39;passwordConfirmation&#39;</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    buttons:&lt;button type&#x3D;&quot;submit&quot;&gt;登录&lt;&#x2F;button&gt;,</span><br><span class="line">    submit: &#123;</span><br><span class="line">      request: formData &#x3D;&gt; axios.post(&#96;&#x2F;api&#x2F;v1&#x2F;users&#96;, formData),</span><br><span class="line">      message: &#96;注册成功&#96;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;h1&gt;注册&lt;&#x2F;h1&gt;</span><br><span class="line">      &#123;form&#125;</span><br><span class="line">    &lt;&#x2F;&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default SignUp;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="codingories.github.io/2020/08/05/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9032js%E4%B8%93%E7%B2%BE01%E4%B9%8B%E6%89%8B%E5%86%99EventHub/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
      <meta itemprop="name" content="Ories">
      <meta itemprop="description" content="这个博客用来记录自己的生活">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="OriesノBlog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/08/05/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9032js%E4%B8%93%E7%B2%BE01%E4%B9%8B%E6%89%8B%E5%86%99EventHub/" class="post-title-link" itemprop="url">高级前端养成32js专精01之手写EventHub</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-08-05 14:07:34" itemprop="dateCreated datePublished" datetime="2020-08-05T14:07:34+08:00">2020-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-08-06 10:05:37" itemprop="dateModified" datetime="2020-08-06T10:05:37+08:00">2020-08-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/js%E4%B8%93%E7%B2%BE/" itemprop="url" rel="index"><span itemprop="name">js专精</span></a>
                </span>
            </span>

          
            <span id="/2020/08/05/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9032js%E4%B8%93%E7%B2%BE01%E4%B9%8B%E6%89%8B%E5%86%99EventHub/" class="post-meta-item leancloud_visitors" data-flag-title="高级前端养成32js专精01之手写EventHub" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/08/05/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9032js%E4%B8%93%E7%B2%BE01%E4%B9%8B%E6%89%8B%E5%86%99EventHub/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/08/05/%E9%AB%98%E7%BA%A7%E5%89%8D%E7%AB%AF%E5%85%BB%E6%88%9032js%E4%B8%93%E7%B2%BE01%E4%B9%8B%E6%89%8B%E5%86%99EventHub/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>一. 解题思路</p>
<ol>
<li>确定 API</li>
<li>添加测试用例</li>
<li>让测试用例通过</li>
<li>重构代码</li>
</ol>
<p>二. 确定 API</p>
<ol>
<li>EventHub#on</li>
<li>EventHub#off</li>
<li>EventHub#emit</li>
</ol>
<p>三. 第一个知识点使用 ts-node 创建项目</p>
<ol>
<li> 创建 EVENTHUB 文件夹</li>
<li> 创建 src/index.ts</li>
<li> 创建 ts-node 支持</li>
<li> 安装 ts-node</li>
</ol>
<pre><code><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">如果有的话先卸载 确定安装最新版</span><br><span class="line">ts-node -v</span><br><span class="line">which ts-node</span><br><span class="line">yarn global add</span><br><span class="line"></span><br><span class="line">开始安装</span><br><span class="line">yarn global add ts-node</span><br><span class="line">(如果有bug @8.3.0)</span><br><span class="line"></span><br><span class="line">index.ts</span><br><span class="line">const a &#x3D; ‘hi’</span><br><span class="line">console.log(a)</span><br></pre></td></tr></table></figure>

5. 运行 ts-node src/index.ts
6. 新建test/index.ts 用来做测试用例


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">src&#x2F;index.ts</span><br><span class="line">class EventHub &#123;&#125;</span><br><span class="line">export default EventHub;</span><br><span class="line"></span><br><span class="line">test&#x2F;index.ts</span><br><span class="line">import EventHub from ‘..&#x2F;src&#x2F;index’;</span><br><span class="line">console.log(EventHub)</span><br><span class="line">尝试运行有没有打印出来</span><br><span class="line">console.log(EventHub);</span><br></pre></td></tr></table></figure></code></pre>
<p>四. 第二个知识点使用断言 console.assert</p>
<ol>
<li>第一个测试用例，断言测试 eventHub 是一个对象是真的</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">test&#x2F;index.ts</span><br><span class="line">import EventHub from ‘..&#x2F;src&#x2F;index’;</span><br><span class="line">console.log(EventHub)</span><br><span class="line">const eventHub &#x3D; new EventHub();</span><br><span class="line">console.log(assert(eventHub instance Object &#x3D;&#x3D;&#x3D; true， “eventHub是一个对象”))</span><br><span class="line">console.assert(eventHub instance Object &#x3D;&#x3D;&#x3D; true， “eventHub是一个对象”))</span><br><span class="line">ts-node test&#x2F;index.ts 如果运行什么东西都没就是对的，否则报错</span><br></pre></td></tr></table></figure>

<p>五. 实现on</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class EventHub &#123;</span><br><span class="line">  cache &#x3D; &#123;&#125;;</span><br><span class="line">  &#x2F;&#x2F; &#123;</span><br><span class="line">  &#x2F;&#x2F;  &#39;楚天都市报&#39;: [fn1, fn2, fn3],</span><br><span class="line">  &#x2F;&#x2F;  &#39;羊城晚报&#39; : [fn1, fn2, fn3]</span><br><span class="line">  &#x2F;&#x2F; &#125;</span><br><span class="line">  on(eventName, fn)&#123;</span><br><span class="line">  &#x2F;&#x2F; eventName订报纸,fn报纸放到邮箱</span><br><span class="line">    &#x2F;&#x2F; eventName订报纸,fn报纸放到邮箱</span><br><span class="line">    &#x2F;&#x2F; eventName &#x3D; 楚天, fn</span><br><span class="line">    if(this.cache[eventName] &#x3D;&#x3D;&#x3D; undefined)&#123;</span><br><span class="line">      this.cache[eventName] &#x3D; []</span><br><span class="line">    &#125;</span><br><span class="line">    const array &#x3D; this.cache[eventName];</span><br><span class="line">    array.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  emit(eventName)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>六. 实现emit，并测试成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">emit(eventName)&#123;</span><br><span class="line">    let array &#x3D; this.cache[eventName];</span><br><span class="line">    if(array&#x3D;&#x3D;&#x3D; undefined)&#123;</span><br><span class="line">      array &#x3D; []</span><br><span class="line">    &#125;</span><br><span class="line">    array.forEach(fn &#x3D;&gt; &#123;</span><br><span class="line">      fn();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 测试代码</span><br><span class="line">let called &#x3D; false;</span><br><span class="line">eventHub.on(&quot;xxx&quot;, ()&#x3D;&gt;&#123;</span><br><span class="line">  console.log(&quot;被调用&quot;)</span><br><span class="line">  called &#x3D; true;</span><br><span class="line">  console.log(&#39;called:&#39;+ called);</span><br><span class="line">&#125;);</span><br><span class="line">eventHub.emit(&quot;xxx&quot;);</span><br></pre></td></tr></table></figure>

<p>七. 优化代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">emit(eventName)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 this.cache[eventName] 数组里面的 fn 全部依次调用</span><br><span class="line">    (this.cache[eventName] || []).forEach(fn &#x3D;&gt; fn());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>八. 完成参数传递</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; src&#x2F;indext.ts</span><br><span class="line">class EventHub &#123;</span><br><span class="line">  cache &#x3D; &#123;&#125;;</span><br><span class="line">  &#x2F;&#x2F; &#123;</span><br><span class="line">  &#x2F;&#x2F;  &#39;楚天都市报&#39;: [fn1, fn2, fn3],</span><br><span class="line">  &#x2F;&#x2F;  &#39;羊城晚报&#39; : [fn1, fn2, fn3]</span><br><span class="line">  &#x2F;&#x2F; &#125;</span><br><span class="line">  on(eventName, fn)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 fn 推进 this.cache[eventName] 数组</span><br><span class="line">    &#x2F;&#x2F; eventName订报纸,fn报纸放到邮箱</span><br><span class="line">    &#x2F;&#x2F; eventName &#x3D; 楚天, fn</span><br><span class="line">    this.cache[eventName] &#x3D; this.cache[eventName] || []</span><br><span class="line">    this.cache[eventName].push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  emit(eventName, data)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 this.cache[eventName] 数组里面的 fn 全部依次调用</span><br><span class="line">    (this.cache[eventName] || []).forEach(fn &#x3D;&gt; fn(data));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default EventHub;</span><br><span class="line">&#x2F;&#x2F; test&#x2F;index.ts</span><br><span class="line">import EventHub from &#39;..&#x2F;src&#x2F;index&#39;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 尝试运行有没有打印出来</span><br><span class="line">const eventHub &#x3D; new EventHub();</span><br><span class="line">console.assert(eventHub instanceof Object, &#39;eventHub是一个对象&#39;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; on emit</span><br><span class="line">let called &#x3D; false;</span><br><span class="line">eventHub.on(&quot;xxx&quot;, (y)&#x3D;&gt;&#123;</span><br><span class="line">  called &#x3D; true;</span><br><span class="line">  console.log(&#39;called:&#39;+ called);</span><br><span class="line">  console.log(y);</span><br><span class="line">  console.assert(y &#x3D;&#x3D;&#x3D; &quot;今天天气不错&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">eventHub.emit(&quot;xxx&quot;, &quot;今天天气不错&quot;);</span><br></pre></td></tr></table></figure>
<p>九. 初步实现off</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">off(eventName, fn)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 fn 从 this.cache[eventName] 数组删除</span><br><span class="line">    this.cache[eventName] &#x3D; this.cache[eventName] || [];</span><br><span class="line">    let index &#x3D; undefined;</span><br><span class="line">    for (let i &#x3D; 0; i &lt; this.cache[eventName].length; i++)&#123;</span><br><span class="line">      if(this.cache[eventName][i] &#x3D;&#x3D;&#x3D; fn)&#123;</span><br><span class="line">        index &#x3D; i;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if(index &#x3D;&#x3D;&#x3D; undefined)&#123;</span><br><span class="line">      return;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">      this.cache[eventName].splice(index,1)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>十. 优化off代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class EventHub &#123;</span><br><span class="line">  cache &#x3D; &#123;&#125;;</span><br><span class="line">  &#x2F;&#x2F; &#123;</span><br><span class="line">  &#x2F;&#x2F;  &#39;楚天都市报&#39;: [fn1, fn2, fn3],</span><br><span class="line">  &#x2F;&#x2F;  &#39;羊城晚报&#39; : [fn1, fn2, fn3]</span><br><span class="line">  &#x2F;&#x2F; &#125;</span><br><span class="line">  on(eventName, fn)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 fn 推进 this.cache[eventName] 数组</span><br><span class="line">    &#x2F;&#x2F; eventName订报纸,fn报纸放到邮箱</span><br><span class="line">    &#x2F;&#x2F; eventName &#x3D; 楚天, fn</span><br><span class="line">    this.cache[eventName] &#x3D; this.cache[eventName] || [];</span><br><span class="line">    this.cache[eventName].push(fn);</span><br><span class="line">  &#125;</span><br><span class="line">  emit(eventName, data?)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 this.cache[eventName] 数组里面的 fn 全部依次调用</span><br><span class="line">    (this.cache[eventName] || []).forEach(fn &#x3D;&gt; fn(data));</span><br><span class="line">  &#125;</span><br><span class="line">  off(eventName, fn)&#123;</span><br><span class="line">    &#x2F;&#x2F; 把 fn 从 this.cache[eventName] 数组删除</span><br><span class="line">    let index &#x3D; indexOf(this.cache[eventName], fn);</span><br><span class="line">    if(index &#x3D;&#x3D;&#x3D; -1)return;</span><br><span class="line">    this.cache[eventName].splice(index,1)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default EventHub;</span><br><span class="line"></span><br><span class="line">function indexOf(array, item) &#123;</span><br><span class="line">  if(array &#x3D;&#x3D;&#x3D; undefined) return -1;</span><br><span class="line">  let index &#x3D; -1;</span><br><span class="line">  for (let i &#x3D; 0; i &lt; array.length; i++)&#123;</span><br><span class="line">    if(array[i] &#x3D;&#x3D;&#x3D; item)&#123;</span><br><span class="line">      index &#x3D; i;</span><br><span class="line">      break;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>十一. 优化测试代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">import EventHub from &#39;..&#x2F;src&#x2F;index&#39;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const test1 &#x3D; (message)&#x3D;&gt;&#123;</span><br><span class="line">  const eventHub &#x3D; new EventHub();</span><br><span class="line">  console.assert(eventHub instanceof Object, &#39;eventHub是一个对象&#39;);</span><br><span class="line">  console.log(message)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">const test2 &#x3D; (message)&#x3D;&gt;&#123;</span><br><span class="line">  const eventHub &#x3D; new EventHub();</span><br><span class="line">  &#x2F;&#x2F; on emit</span><br><span class="line">  let called &#x3D; false;</span><br><span class="line">  eventHub.on(&quot;xxx&quot;, (y)&#x3D;&gt;&#123;</span><br><span class="line">    called &#x3D; true;</span><br><span class="line">    console.assert(y &#x3D;&#x3D;&#x3D; &quot;今天天气不错&quot;);</span><br><span class="line">  &#125;);</span><br><span class="line">  eventHub.emit(&quot;xxx&quot;, &quot;今天天气不错&quot;);</span><br><span class="line">  setTimeout(()&#x3D;&gt;&#123;</span><br><span class="line">    console.assert(called &#x3D;&#x3D;&#x3D; true)</span><br><span class="line">    console.log(message)</span><br><span class="line">  &#125;,1000)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">const test3 &#x3D; (message)&#x3D;&gt;&#123;</span><br><span class="line">  const eventHub &#x3D; new EventHub();</span><br><span class="line">  &#x2F;&#x2F; 另一个完全不同的送报纸公司</span><br><span class="line">  let called &#x3D; false;</span><br><span class="line">  const fn1 &#x3D; () &#x3D;&gt; &#123;</span><br><span class="line">    called &#x3D; true;</span><br><span class="line">  &#125;;</span><br><span class="line">  eventHub.on(&quot;yyy&quot;, fn1);</span><br><span class="line">  eventHub.off(&quot;yyy&quot;, fn1);</span><br><span class="line">  eventHub.emit(&quot;yyy&quot;);</span><br><span class="line">  setTimeout(()&#x3D;&gt;&#123;</span><br><span class="line">    console.assert(called &#x3D;&#x3D;&#x3D; false);</span><br><span class="line">    console.log(message)</span><br><span class="line">  &#125;,1000);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test1(&quot;EventHub 可以创建对象&quot;);</span><br><span class="line">test2(&quot;.on 了之后 .emit, 会触发 .on的函数&quot;);</span><br><span class="line">test3(&quot;.off 有用&quot;);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ories"
      src="https://i.loli.net/2020/07/12/RPjkZxei6agC49U.jpg">
  <p class="site-author-name" itemprop="name">Ories</p>
  <div class="site-description" itemprop="description">这个博客用来记录自己的生活</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">249</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">74</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/codingories" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;codingories" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ories</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('https://cdn.jsdelivr.net/npm/valine@1.3.9/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'HHvArpMYcwuYjNb3703JgvvS-gzGzoHsz',
      appKey     : '5lSamU58UyScrMIQcUygcD2I',
      placeholder: "欢迎畅所欲言",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : 'true'
    });
  }, window.Valine);
});
</script>

</body>
</html>
